-- Generated by CoDLuaDecompiler
-- Version: 2.4.2
-- Date: 21-11-2025 08:49
module( ..., package.seeall )
FenceSignIn = LUI.Class( LUI.Fence )
FenceSignIn.ACCOUNT_PICKER_STATE = {
	picking = 2,
	inactive = 1
}
FenceSignIn.init = function ( f25_arg0 )
	LUI.Fence.init( f25_arg0 )
	f25_arg0._smsChallengePassed = false
	f25_arg0._smsScreenOpened = false
	f25_arg0._smsUrl = ""
	f25_arg0._phoneVerificationPassed = false
	f25_arg0._phoneVerificationScreenOpened = false
	f25_arg0._perController = {}
	for f25_local0 = 0, Engine[0xB686A0A723E6442]() - 1, 1 do
		f25_arg0._perController[f25_local0] = {
			accountPickerState = FenceSignIn.ACCOUNT_PICKER_STATE.inactive
		}
	end
end

FenceSignIn.Start = function ( f24_arg0 )
	DebugPrint( "FenceSignIn.Start" )
end

FenceSignIn.Stop = function ( f23_arg0 )
	DebugPrint( "FenceSignIn.Stop" )
end

FenceSignIn.PostFail = function ( f22_arg0 )
	local f22_local0 = LUI.WebViewManager.Instance()
	if f22_local0:GetAndResetDeclinedEula() then
		return 
	end
	f22_local0 = Engine[0x45B054C920178E9]()
	if f22_arg0._state == LUI.Fence.STATE.fail then
		if CONDITIONS.IsPermanentOrTemporaryBan( f22_local0 ) then
			if Dvar[0x9E5BE3B4BBA4E0E]( 0x89899570DE48485 ) and CONDITIONS.MobileIsBootPresentationEnabled() then
				Web[0xE5D144212B21563]()
			else
				LUI.FlowManager.RequestPopupMenu( nil, "popup_ban", false, f22_local0, false, {
					controllerIndex = f22_local0,
					noPremium = f22_arg0._noPremium
				}, nil, false, false )
			end
		end
		if not CONDITIONS.IsMenuInStack( "MainLockoutMenu" ) then
			LUI.FlowManager.RequestSetStack( "MainLockoutMenu", {
				name = "MainLockoutMenu"
			} )
			LUI.FlowManager.RequestAutomaticNavigation( PartyUIRoot.LOCKOUT_MENU )
		end
		LUI.FlowManager.RequestPopupMenu( nil, "popup_signin_error", false, f22_local0, not LUI.FlowManager.IsMenuOnTop( "MainLockoutMenu" ), {}, nil, false, true )
	end
end

function PopupSignInQueue( f20_arg0, f20_arg1 )
	assert( f20_arg1 )
	local f20_local0 = {
		message = Engine[0xED84C33EC5F01EA]( 0xA479AD2705AC200 ),
		description = Engine[0xED84C33EC5F01EA]( 0x62EA86FE707A789 ),
		buttons = {
			label = Engine[0xED84C33EC5F01EA]( Engine[0x575E9C5B9AAB6F4]() and 0x4E76830223A336F or 0x3956F54E845F7DE ),
			alignment = LUI.Alignment.Center,
			action = function ()
				if Engine[0x575E9C5B9AAB6F4]() then
					Engine[0xDEE6107B26F8BB6]()
				else
					LUI.FlowManager.RequestLeaveMenu()
				end
			end
		}
	}
	local f20_local1 = f20_arg1.controllerIndex
	if not f20_local1 then
		f20_local1 = Engine[0x45B054C920178E9]()
	end
	f20_local0.controllerIndex = f20_local1
	f20_local1 = MenuBuilder.BuildRegisteredType( "FenceSigninQueueDialogPopup", f20_local0 )
	f20_local1.id = "popup_signin_queue"
	return f20_local1
end

FenceSignIn.OpenSignInQueuedPopup = function ( f18_arg0 )
	local f18_local0 = f18_arg0
	LUI.FlowManager.RequestPopupMenu( nil, "popup_signin_queue", false, nil, false, {
		onCancel = function ( f19_arg0, f19_arg1 )
			f18_arg0._perController[f19_arg1].isCancelling = true
		end
	}, nil, true, true )
	f18_arg0._openedWaitPopup = "popup_signin_queue"
end

local f0_local0 = function ( f17_arg0, f17_arg1 )
	if Engine[0x9DD5167C6D720F1]() then
		local f17_local0 = LUI.FlowManager.GetTopMostOpenMenuInfo( nil )
		if f17_local0 and f17_local0.buildData then
			local f17_local1 = f17_local0.buildData.isOnboardingMatureContent
			if not f17_local1 then
				f17_local1 = f17_local0.buildData.isCrossLaunchCampaignMenu
			end
			return f17_local1
		end
	end
	return false
end

local f0_local1 = function ( f16_arg0 )
	PHONE_VERIFICATION.CreateSMSToastNotification( f16_arg0, 0xCF305AEE3E2B4F6, 0x7124BFEC60F6DC2, LUI.ToastManager.ToastNotificationType.DisruptiveBehaviorPositive, LUI.ToastManager.ToastVisualEffect.Positive )
	Engine[0x66C6B75030ED005]( "phoneVerificationRestartPending", f16_arg0 )
	Engine[0xB81A5136C5503E4]( "updategamerprofile " .. f16_arg0 )
end

FenceSignIn.ProcessingBattleNetSignIn = function ( f14_arg0 )
	local f14_local0 = 0
	if not Engine[0xD2813B521711C11]( f14_local0 ) then
		local f14_local1 = Engine[0x170DF85DCE182E7]()
		local f14_local2 = function ( f15_arg0 )
			if f14_arg0._openedWaitPopup ~= nil and f14_arg0._openedWaitPopup ~= f15_arg0 then
				LUI.FlowManager.RequestLeaveMenuByName( f14_arg0._openedWaitPopup, true )
				f14_arg0._openedWaitPopup = nil
				return true
			elseif f14_arg0._openedWaitPopup == nil then
				return true
			else
				return false
			end
		end
		
		if f14_local1 then
			if f14_local2( "popup_signin_queue" ) then
				f14_arg0:OpenSignInQueuedPopup()
			end
		elseif f14_arg0._openedWaitPopup then
			LUI.FlowManager.RequestLeaveMenuByName( f14_arg0._openedWaitPopup, true )
			f14_arg0._openedWaitPopup = nil
		end
		local f14_local3 = Engine[0x2D5DC5650ED3A1E]( f14_local0 )
		if f14_local3 == BattleNetAuthState.NOT_SIGNED_IN and Engine[0xAF7EC673FFF4FE4]() ~= nil then
			f14_arg0._state = LUI.Fence.STATE.fail
			DebugPrint( "FenceSignIn FAILED, BattleNet not signed in" )
		elseif f14_local3 ~= BattleNetAuthState.SIGNED_IN then
			f14_arg0._state = LUI.Fence.STATE.block
		end
	elseif f14_arg0:ProcessingLegacySMSChallenge( f14_local0 ) then
		return 
	elseif f14_arg0._openedWaitPopup then
		LUI.FlowManager.RequestLeaveMenuByName( f14_arg0._openedWaitPopup, true )
		f14_arg0._openedWaitPopup = nil
	end
end

FenceSignIn.ProcessingSteamSignIn = function ( f13_arg0 )
	local f13_local0 = 0
	local f13_local1 = Engine[0xD2813B521711C11]( f13_local0 )
	local f13_local2 = CONDITIONS.IsUserSignedInDemonware( f13_local0 )
	if f13_local1 and not f13_local2 then
		if f13_arg0:ProcessingLegacyPhoneVerification( f13_local0 ) then
			return 
		elseif f13_arg0._phoneVerificationPassed and not f13_arg0._phoneVerificationScreenOpened and f13_arg0:ProcessingLegacySMSChallenge( f13_local0 ) then
			return 
		end
	elseif f13_local2 then
		if f13_arg0:ProcessingFTUEVerification( f13_local0 ) then
			return 
		elseif f13_arg0:ProcessingPhoneVerification( f13_local0 ) then
			return 
		elseif f13_arg0._phoneVerificationPassed and not f13_arg0._phoneVerificationScreenOpened and f13_arg0:ProcessingSMSChallenge( f13_local0 ) then
			return 
		end
		local f13_local3 = Engine[0x7B17D94988FD5D0]( "phoneVerificationRestartPending", f13_local0 )
		if f13_local3 then
			if not Dvar[0x9E5BE3B4BBA4E0E]( 0x52210C273E4FAE0 ) then
				f13_local3 = not Engine[0x98412622299B71C]()
			else
				f13_local3 = false
			end
		end
		if f13_local3 then
			f0_local0( f13_local0 )
		end
	elseif Engine[0xAF7EC673FFF4FE4]() ~= nil then
		f13_arg0._state = LUI.Fence.STATE.fail
		DebugPrint( "FenceSignIn FAILED, Steam disconnected" )
	end
end

FenceSignIn.ProcessingLegacyPhoneVerification = function ( f12_arg0, f12_arg1 )
	local f12_local0 = PHONE_VERIFICATION.IsPhoneVerificationChallengeRequiredBeforeLogin( f12_arg1 )
	local f12_local1 = Dvar[0x9E5BE3B4BBA4E0E]( 0x91E4E281AD10279 )
	if f12_arg0._phoneVerificationPassed and not f12_local0 and not f12_local1 then
		return false
	elseif not f12_arg0._phoneVerificationPassed and not f12_arg0._phoneVerificationScreenOpened then
		if f12_local1 or f12_local0 then
			f12_arg0._phoneVerificationPassed = false
		else
			f12_arg0._phoneVerificationPassed = true
		end
		if f12_arg0._phoneVerificationPassed then
			DebugPrint( "FenceSignIn | Phone verification has passed successfully" )
			return false
		end
	end
	if not f12_arg0._phoneVerificationPassed or f12_local0 or f12_local1 then
		if not f12_arg0._phoneVerificationScreenOpened then
			f12_arg0._state = LUI.Fence.STATE.block
			f12_arg0._phoneVerificationScreenOpened = true
			LUI.FlowManager.RequestPopupMenu( nil, "SMSVerificationMenu", false, f12_arg1, false, {
				legacyFlow = true,
				screen = PHONE_VERIFICATION.SCREEN.PHONE_VERIFICATION_STEAM
			}, nil, true, true )
			return true
		elseif f12_arg0._phoneVerificationScreenOpened and not LUI.FlowManager.IsInStack( "SMSVerificationMenu" ) and not f0_local0( f12_arg0, f12_arg1 ) then
			f12_arg0._state = LUI.Fence.STATE.pass
			f12_arg0._phoneVerificationScreenOpened = false
			f12_arg0._phoneVerificationPassed = true
			return false
		end
		f12_arg0._state = LUI.Fence.STATE.block
		return true
	elseif f12_arg0._phoneVerificationScreenOpened and not f12_arg0._phoneVerificationPassed then
		f12_arg0._state = LUI.Fence.STATE.block
		return true
	end
	f12_arg0._phoneVerificationPassed = true
	return false
end

FenceSignIn.ProcessingPhoneVerification = function ( f11_arg0, f11_arg1 )
	local f11_local0 = PHONE_VERIFICATION.IsPhoneRequired( f11_arg1 )
	local f11_local1 = Dvar[0x9E5BE3B4BBA4E0E]( 0x375CA29406A46CF )
	if f11_arg0._phoneVerificationPassed and not f11_local0 and not f11_local1 then
		return false
	elseif not f11_arg0._phoneVerificationPassed and not f11_arg0._phoneVerificationScreenOpened then
		if f11_local1 or f11_local0 then
			Engine[0x9694388D6DAC134]( "phoneVerificationRestartPending", false, f11_arg1 )
			Engine[0xB81A5136C5503E4]( "updategamerprofile " .. f11_arg1 )
			f11_arg0._phoneVerificationPassed = false
		else
			f11_arg0._phoneVerificationPassed = true
		end
		if f11_arg0._phoneVerificationPassed then
			DebugPrint( "FenceSignIn | Phone verification has passed successfully" )
			return false
		end
	end
	if not f11_arg0._phoneVerificationPassed or f11_local0 or f11_local1 then
		if not f11_arg0._phoneVerificationScreenOpened then
			f11_arg0._state = LUI.Fence.STATE.block
			f11_arg0._phoneVerificationScreenOpened = true
			LUI.FlowManager.RequestPopupMenu( nil, "SMSVerificationMenu", false, f11_arg1, false, {
				screen = PHONE_VERIFICATION.SCREEN.PHONE_VERIFICATION_STEAM
			}, nil, true, true )
			return true
		elseif f11_arg0._phoneVerificationScreenOpened and not LUI.FlowManager.IsInStack( "SMSVerificationMenu" ) and not f0_local0( f11_arg0, f11_arg1 ) then
			f11_arg0._state = LUI.Fence.STATE.pass
			f11_arg0._phoneVerificationScreenOpened = false
			f11_arg0._phoneVerificationPassed = true
			return false
		end
		f11_arg0._state = LUI.Fence.STATE.block
		return true
	elseif f11_arg0._phoneVerificationScreenOpened and not f11_arg0._phoneVerificationPassed then
		f11_arg0._state = LUI.Fence.STATE.block
		return true
	end
	f11_arg0._phoneVerificationPassed = true
	return false
end

FenceSignIn.ProcessingLegacySMSChallenge = function ( f10_arg0, f10_arg1 )
	local f10_local0 = PHONE_VERIFICATION.IsSMSChallengeRequiredBeforeLogin( f10_arg1 )
	local f10_local1 = Dvar[0x9E5BE3B4BBA4E0E]( 0x7D99B3CCD4FD1BE )
	if f10_arg0._smsChallengePassed and not f10_local0 and not f10_local1 then
		return false
	elseif not f10_arg0._smsChallengePassed and not f10_arg0._smsScreenOpened then
		if f10_local1 or f10_local0 then
			f10_arg0._smsChallengePassed = false
		else
			f10_arg0._smsChallengePassed = true
		end
		if f10_arg0._smsChallengePassed then
			return false
		end
	end
	if not f10_arg0._smsChallengePassed or f10_local0 or f10_local1 then
		if not f10_arg0._smsScreenOpened then
			if f10_local1 then
				f10_arg0._smsUrl = "https://www.smsTestUrl.com"
			else
				local f10_local2 = Engine[0xEA75A9E50322B3E]( f10_arg1 )
				if not f10_local2.isCompleted and f10_local2.mechanism == "sms" then
					f10_arg0._smsUrl = f10_local2.url
				end
			end
			f10_arg0._state = LUI.Fence.STATE.block
			f10_arg0._smsScreenOpened = true
			LUI.FlowManager.RequestPopupMenu( nil, "SMSVerificationMenu", false, f10_arg1, false, {
				legacyFlow = true,
				screen = Engine[0x5575DCFF312365A]() and PHONE_VERIFICATION.SCREEN.SMS_BNET or PHONE_VERIFICATION.SCREEN.SMS_STEAM,
				url = f10_arg0._smsUrl
			}, nil, true, true )
			return true
		elseif f10_arg0._smsScreenOpened and not LUI.FlowManager.IsInStack( "SMSVerificationMenu" ) then
			f10_arg0._state = LUI.Fence.STATE.pass
			f10_arg0._smsChallengePassed = true
			return false
		end
		f10_arg0._state = LUI.Fence.STATE.block
		return true
	elseif f10_arg0._smsScreenOpened and not f10_arg0._smsChallengePassed then
		f10_arg0._state = LUI.Fence.STATE.block
		return true
	end
	f10_arg0._smsChallengePassed = true
	return false
end

FenceSignIn.ProcessingSMSChallenge = function ( f9_arg0, f9_arg1 )
	local f9_local0 = PHONE_VERIFICATION.IsUserChallenged( f9_arg1 )
	local f9_local1 = Dvar[0x9E5BE3B4BBA4E0E]( 0x3FE1728C4DF0D0C )
	if f9_arg0._smsChallengePassed and not f9_local0 and not f9_local1 then
		return false
	elseif not f9_arg0._smsChallengePassed and not f9_arg0._smsScreenOpened then
		if f9_local0 or f9_local1 then
			f9_arg0._smsChallengePassed = false
		else
			f9_arg0._smsChallengePassed = true
		end
		if f9_arg0._smsChallengePassed then
			return false
		end
	end
	if not f9_arg0._smsChallengePassed or f9_local0 or f9_local1 then
		if not f9_arg0._smsScreenOpened then
			if f9_local1 then
				f9_arg0._smsUrl = "https://www.smsTestUrl.com"
			else
				local f9_local2 = Engine[0x214330D651CD9C1]( f9_arg1 )
				if not f9_local2.isCompleted and f9_local2.mechanism == "sms" then
					f9_arg0._smsUrl = f9_local2.url
				end
			end
			f9_arg0._state = LUI.Fence.STATE.block
			f9_arg0._smsScreenOpened = true
			LUI.FlowManager.RequestPopupMenu( nil, "SMSVerificationMenu", false, f9_arg1, false, {
				screen = Engine[0x5575DCFF312365A]() and PHONE_VERIFICATION.SCREEN.SMS_BNET or PHONE_VERIFICATION.SCREEN.SMS_STEAM,
				url = f9_arg0._smsUrl
			}, nil, true, true )
			return true
		elseif f9_arg0._smsScreenOpened and not LUI.FlowManager.IsInStack( "SMSVerificationMenu" ) then
			f9_arg0._state = LUI.Fence.STATE.pass
			f9_arg0._smsChallengePassed = true
			return false
		end
		f9_arg0._state = LUI.Fence.STATE.block
		return true
	elseif f9_arg0._smsScreenOpened and not f9_arg0._smsChallengePassed then
		f9_arg0._state = LUI.Fence.STATE.block
		return true
	end
	f9_arg0._smsChallengePassed = true
	return false
end

FenceSignIn.ProcessingFTUEVerification = function ( f8_arg0, f8_arg1 )
	local f8_local0 = Engine[0x1AE85ADF7F2BA4D]()
	if not f8_local0 then
		f8_local0 = Engine[0x7B17D94988FD5D0]( "acceptedEULA", f8_arg1 )
		if f8_local0 then
			f8_local0 = Engine[0x7B17D94988FD5D0]( "hasEverSeen_CODAccount", f8_arg1 )
		end
	end
	return not f8_local0
end

FenceSignIn.UpdateState = function ( f7_arg0 )
	assert( f7_arg0._state ~= LUI.Fence.STATE.fail )
	f7_arg0._state = LUI.Fence.STATE.pass
	if Engine[0x21103F2ABD5B496]() then
		f7_arg0._state = LUI.Fence.STATE.pass
		return 
	elseif Engine[0x5575DCFF312365A]() then
		f7_arg0:ProcessingBattleNetSignIn()
		return 
	elseif Engine[0x9DD5167C6D720F1]() then
		f7_arg0:ProcessingSteamSignIn()
		return 
	elseif Engine[0xE457944EE65BCA1]() then
		f7_arg0._state = LUI.Fence.STATE.block
		return 
	end
	for f7_local0 = 0, Engine[0xB686A0A723E6442]() - 1, 1 do
		if Engine[0x10A5732AB1DAE9F]( f7_local0 ) and not Engine[0xD2813B521711C11]( f7_local0 ) then
			local f7_local3 = assert
			local f7_local4 = Engine[0x688D9FAA39ECE94]()
			if not f7_local4 then
				f7_local4 = Engine[0x688D8FAA39ECCE1]()
				if not f7_local4 then
					f7_local4 = Engine[0x2BFF02F7B2CDB47]()
					if not f7_local4 then
						f7_local4 = Engine[0x926B1DECE2B6039]()
					end
				end
			end
			f7_local3( f7_local4 )
			if f7_arg0._perController[f7_local0].accountPickerState == FenceSignIn.ACCOUNT_PICKER_STATE.inactive then
				f7_arg0._state = LUI.Fence.STATE.block
				f7_arg0._perController[f7_local0].accountPickerState = FenceSignIn.ACCOUNT_PICKER_STATE.picking
				Engine[0x4DECC2B7654EAB1]( f7_local0, false )
				return 
			end
		end
	end
	local f7_local0 = 0
	local f7_local1 = 0
	for f7_local2 = 0, Engine[0xB686A0A723E6442]() - 1, 1 do
		if Engine[0x10A5732AB1DAE9F]( f7_local2 ) and Engine[0xD2813B521711C11]( f7_local2 ) then
			f7_local0 = f7_local0 + 1
			if not Engine[0x757E77CA15D6B8F]( f7_local2 ) then
				f7_local1 = f7_local1 + 1
			end
		end
	end
	local f7_local2 = false
	if Dvar[0x9E5BE3B4BBA4E0E]( 0x3DDB961100B5F47 ) and Engine[0x1DCFAFA7CE6F8D0]() and 0 < f7_local0 then
		f7_local2 = true
	end
	if 0 < f7_local0 and 0 < f7_local1 then
		f7_local2 = true
	end
	if f7_local2 then
		for f7_local5 = 0, Engine[0xB686A0A723E6442]() - 1, 1 do
			if Engine[0x10A5732AB1DAE9F]( f7_local5 ) and not Engine[0xD2813B521711C11]( f7_local5 ) then
				Engine[0x54DE5FB69D3BA90]( f7_local5 )
				f7_arg0._perController[f7_local5].accountPickerState = FenceSignIn.ACCOUNT_PICKER_STATE.inactive
			end
		end
	else
		f7_arg0._state = LUI.Fence.STATE.fail
		DebugPrint( "FenceSignIn FAILED" )
	end
end

function PopupSignInError( f1_arg0, f1_arg1 )
	local f1_local0 = 0xD1ED4A270AD4A2F
	if Engine[0x1DCFAFA7CE6F8D0]() then
		f1_local0 = 0xC6EFCA78C461C6
	end
	if Engine[0x9258F49F515F97B]() then
		f1_local0 = 0x91298E49D2B36AC
	end
	local f1_local1 = {
		controllerIndex = f1_arg1.controllerIndex,
		title = Engine[0xED84C33EC5F01EA]( 0xBDAA9535F4F682B ),
		message = Engine[0xED84C33EC5F01EA]( f1_local0 ),
		buttons = {
			{
				label = Engine[0xED84C33EC5F01EA]( 0x5C33DA8F6CE65B0 ),
				action = function ()
					
				end
			}
		}
	}
	if Engine[0x5575DCFF312365A]() or Engine[0x9DD5167C6D720F1]() or Engine[0x926B1DECE2B6039]() then
		f1_local1.message = Engine[0xAF7EC673FFF4FE4]()
		f1_local1.buttons[1].label = Engine[0xED84C33EC5F01EA]( 0x4E76830223A336F )
		f1_local1.buttons[1].action = function ()
			Engine[0xDEE6107B26F8BB6]()
		end
		
		if Engine[0xE46B11F69B0F4D5]() then
			f1_local1.useMessageContainer = true
			f1_local1.messageContainerHeight = 300 * _1080p
			table.insert( f1_local1.buttons, 1, {
				label = Engine[0xED84C33EC5F01EA]( 0xCEEE7DB3E04E2C1 ),
				action = function ()
					Engine[0xA265A859B7C189E]( f1_arg0.controllerIndex, 0, "https://account.blizzard.com/details#phone-number" )
					Engine[0xDEE6107B26F8BB6]()
				end
			} )
		end
		if Engine[0x6983E9F2847EAED]() then
			table.insert( f1_local1.buttons, {
				label = Engine[0xED84C33EC5F01EA]( 0x8010973A5846CDA ),
				action = function ( f3_arg0, f3_arg1 )
					Engine[0x34C623E28A1C5E7]( "" )
				end
			} )
		end
		if Engine[0xD87B38D9E227ECC]() then
			if CONDITIONS.IsLFPEnabled() then
				LFP.ForceEndPlayerLFPSession( {
					resetAllData = false,
					eventName = LFP.SEARCH_RESULTS.DISCONNECT
				} )
			end
			f1_local1.title = Engine[0xED84C33EC5F01EA]( 0xD5DFD124B6C28D2 )
		end
	end
	local f1_local2 = MenuBuilder.BuildRegisteredType( "PopupMessageAndButtons", f1_local1 )
	f1_local2.id = "popup_signin_error"
	f1_local2:registerEventHandler( "not_below_blocking_fence", function ( element, event )
		if Engine[0x9D348E40740E9A8]() then
			Engine[0xE49CE4BCE0701D5]( "Sign in fence failed" )
			Dvar[0x8EA06EEDB58D872]( 0xD360034020A5D7A, false )
		end
	end )
	return f1_local2
end

MenuBuilder.registerType( "popup_signin_queue", PopupSignInQueue )
MenuBuilder.registerType( "popup_signin_error", PopupSignInError )
LUI.Fence.Register( "signIn", FenceSignIn )
LockTable( _M )
