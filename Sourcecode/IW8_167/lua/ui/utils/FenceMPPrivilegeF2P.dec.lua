-- Generated by CoDLuaDecompiler
-- Version: 2.4.2
-- Date: 13-07-2025 21:51
module( ..., package.seeall )
FenceMPPrivilegeF2P = LUI.Class( LUI.Fence )
FenceMPPrivilegeF2P.init = function ( f10_arg0 )
	LUI.Fence.init( f10_arg0 )
end

FenceMPPrivilegeF2P.Start = function ( f9_arg0 )
	DebugPrint( "FenceMPPrivilegeF2P.Start" )
	f9_arg0._hasActiveClient = {}
	f9_arg0._privilegeData = {}
	f9_arg0._hasStartPrivilegeDeniedResolve = false
	f9_arg0._hasStartPrivilegeCheckFailedResolve = false
	for f9_local0 = 0, Engine.DCJGJDDEHE() - 1, 1 do
		f9_arg0._hasActiveClient[f9_local0] = Engine.BBHAECABBD( f9_local0 )
		if f9_arg0._hasActiveClient[f9_local0] then
			local f9_local3, f9_local4 = Engine.CFHECDBFGF( f9_local0, true )
			f9_arg0._privilegeData[f9_local0] = {
				hasMPPrivilege = f9_local3,
				errorCode = f9_local4
			}
		end
	end
end

FenceMPPrivilegeF2P.Stop = function ( f8_arg0 )
	DebugPrint( "FenceMPPrivilegeF2P.Stop" )
	f8_arg0._hasStartPrivilegeDeniedResolve = false
	f8_arg0._hasStartPrivilegeCheckFailedResolve = false
end

FenceMPPrivilegeF2P.PostFail = function ( f7_arg0 )
	if f7_arg0._state == LUI.Fence.STATE.fail then
		local f7_local0 = Engine.IJEBHJIJF()
		LUI.FlowManager.RequestPopupMenu( nil, "PopupMPPrivilegeF2PError", false, f7_local0, false, {
			controllerIndex = f7_local0
		}, nil, false, true )
	end
end

FenceMPPrivilegeF2P.OnBackOut = function ( f6_arg0 )
	DebugPrint( "FenceMPPrivilegeF2P.OnBackOut" )
	Engine.EBIDFIDHIE( "xcancelinvitejoin", Engine.IJEBHJIJF() )
	if Engine.DAFGFCFHJI and not Lobby.DFFFFJHCEH() then
		Engine.DAGFFDGFII( "xstopparty" )
	end
	if Lobby.GFFECBCCF() and not Lobby.BGIADHIHAG() then
		Engine.DAGFFDGFII( "xstopprivateparty" )
		Engine.DAGFFDGFII( "xstartprivateparty" )
	end
end

FenceMPPrivilegeF2P.UpdateState = function ( f5_arg0 )
	assert( f5_arg0._state ~= LUI.Fence.STATE.fail )
	f5_arg0._state = LUI.Fence.STATE.pass
	for f5_local0 = 0, Engine.DCJGJDDEHE() - 1, 1 do
		if f5_arg0._hasActiveClient[f5_local0] and f5_arg0._privilegeData[f5_local0] and f5_arg0._privilegeData[f5_local0].hasMPPrivilege == false then
			f5_arg0._state = LUI.Fence.STATE.block
			if f5_arg0._privilegeData[f5_local0].errorCode == LUI.FENCE_ONLINE_SERVICES_ERROR_CODES.PlatformXboxLivePrivilegeDenied then
				if not f5_arg0._hasStartPrivilegeDeniedResolve then
					f5_arg0._hasStartPrivilegeDeniedResolve = true
					DebugPrint( "FenceMPPrivilegeF2P.UpdateState - Trying to reolve privilege issue" )
					Engine.IAHJEFHBI( f5_local0, LUI.XBOX_PRIVILEGES.Sessions189 )
				end
				if not Engine.DJDBGJAHDJ( f5_local0, LUI.XBOX_PRIVILEGES.Sessions189 ) then
					local f5_local3, f5_local4 = Engine.CFHECDBFGF( f5_local0, false )
					f5_arg0._privilegeData[f5_local0] = {
						hasMPPrivilege = f5_local3,
						errorCode = f5_local4
					}
					if f5_arg0._privilegeData[f5_local0].hasMPPrivilege then
						f5_arg0._state = LUI.Fence.STATE.pass
					else
						f5_arg0._state = LUI.Fence.STATE.fail
					end
				end
				f5_arg0._state = LUI.Fence.STATE.block
			end
			if f5_arg0._privilegeData[f5_local0].errorCode == LUI.FENCE_ONLINE_SERVICES_ERROR_CODES.PlatformXboxLivePrivilegeCheckFailed then
				if not f5_arg0._hasStartPrivilegeCheckFailedResolve then
					f5_arg0._hasStartPrivilegeCheckFailedResolve = true
					DebugPrint( "FenceMPPrivilegeF2P.UpdateState - Trying to reolve privilege check failed issue" )
					Engine.LUI_CoD_LuaCall_SystemUIForPrivilegeCheckFailedXboxStart( f5_local0 )
				end
				if not Engine.LUI_CoD_LuaCall_SystemUIForPrivilegeCheckFailedXboxIsPending( f5_local0 ) then
					local f5_local3, f5_local4 = Engine.CFHECDBFGF( f5_local0, true )
					f5_arg0._privilegeData[f5_local0] = {
						hasMPPrivilege = f5_local3,
						errorCode = f5_local4
					}
					if f5_arg0._privilegeData[f5_local0].hasMPPrivilege then
						f5_arg0._state = LUI.Fence.STATE.pass
					else
						f5_arg0._state = LUI.Fence.STATE.fail
					end
				end
				f5_arg0._state = LUI.Fence.STATE.block
			end
		end
	end
end

function GetErrorMessageButtons( f2_arg0 )
	return {
		{
			label = Engine.CBBHFCGDIC( "MENU/OK" ),
			action = function ( f4_arg0, f4_arg1 )
				LUI.FlowManager.RequestLeaveMenu( f4_arg0:GetCurrentMenu(), true )
			end
			
		},
		{
			label = Engine.CBBHFCGDIC( "MENU/GO_OFFLINE" ),
			action = function ( f3_arg0, f3_arg1 )
				Dvar.DHEGHJJJHI( "splitscreen", false )
				Engine.CDGCBCBAJ( "Going Offline", f2_arg0 )
				Engine.DAGFFDGFII( "xstopprivateparty" )
				Engine.DAGFFDGFII( "xstartprivateparty" )
				LUI.FlowManager.RequestLeaveMenu( f3_arg0:GetCurrentMenu(), true )
				LUI.FlowManager.RequestAddMenu( "MainMenuOffline", false, f2_arg0 )
			end
			
		}
	}
end

function PopupMPPrivilegeF2PError( f1_arg0, f1_arg1 )
	assert( f1_arg1 )
	local f1_local0 = MenuBuilder.BuildRegisteredType( "GenericImagePopup", {
		controllerIndex = f1_arg1.controllerIndex,
		title = Engine.CBBHFCGDIC( "MENU/CONNECTION_FAILED" ),
		message = Engine.CBBHFCGDIC( "XBOXLIVE/MPNOTALLOWED" ),
		buttons = GetErrorMessageButtons( f1_arg1.controllerIndex )
	} )
	f1_local0.id = "PopupMPPrivilegeF2PError"
	return f1_local0
end

MenuBuilder.registerType( "PopupMPPrivilegeF2PError", PopupMPPrivilegeF2PError )
LUI.Fence.Register( "mpPrivilegeF2P", FenceMPPrivilegeF2P )
LockTable( _M )
