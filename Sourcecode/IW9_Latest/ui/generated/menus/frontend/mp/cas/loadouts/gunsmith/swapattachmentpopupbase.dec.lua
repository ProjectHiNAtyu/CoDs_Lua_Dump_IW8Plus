-- Generated by CoDLuaDecompiler
-- Version: 2.4.2
-- Date: 13-10-2025 14:16
module( ..., package.seeall )
local f0_local0 = 150 * _1080p
local f0_local1 = 410
local f0_local2 = function ( f21_arg0, f21_arg1, f21_arg2 )
	local f21_local0 = false
	for f21_local1 = 1, #f21_arg1, 1 do
		if f21_arg1[f21_local1].value ~= 0 then
			f21_local0 = true
			break
		end
	end
	local f21_local1 = ACTIONS.AnimateSequence
	local f21_local3 = f21_arg0
	local f21_local4
	if f21_local0 then
		f21_local4 = "Show"
	else
		f21_local4 = "Hide"
	end
	local f21_local5
	if f21_arg2 then
		f21_local5 = "SwapModifiers"
	else
		f21_local5 = "EquipModifiers"
	end
	f21_local1( f21_local3, f21_local4 .. f21_local5 )
end

local f0_local3 = function ( f20_arg0, f20_arg1, f20_arg2, f20_arg3, f20_arg4, f20_arg5, f20_arg6 )
	local f20_local0 = ATTACHMENT.GetTableWithCurrentAttachment( f20_arg5, f20_arg4, nil, f20_arg2, nil )
	local f20_local1 = WEAPON.GetWeaponModelName( f20_arg5.weapon, f20_local0, {
		includeAttachments = true
	} )
	local f20_local2 = nil
	if f20_arg6 then
		if not ClientWeapon[0x75228338D174290]( f20_arg1, WEAPON.GetWeaponModelNameFromRef( f20_arg5.weapon ), false, true, true ) then
			return 
		end
		f20_local2 = ClientWeapon[0x75228338D174290]( f20_arg1, f20_local1, false, true, true )
	else
		f20_local2 = f20_arg0._weaponAttributes
	end
	if f20_local2 then
		local f20_local3 = GL_HACK.GetWeaponMPRef( f20_arg5.weapon )
		local f20_local4 = f20_local1
		local f20_local5 = {}
		local f20_local6 = f20_local5.weaponStringWithNewAttachment
		local f20_local7 = nil
		GUNSMITH.SetupWeaponDefaultAttachmentDataForEquippedAttachment( f20_local5, f20_arg1, f20_local3, f20_local1, f20_local0.attachments, f20_arg3, f20_arg2, f20_local0 )
		if not String.IsNilOrEmpty( f20_local6 ) then
			f20_local7 = ClientWeapon[0xFE24333F9BC2CAB]( f20_arg1, f20_local6, f20_arg3 )
			f20_local4 = f20_local6
		else
			f20_local7 = ClientWeapon[0xFE24333F9BC2CAB]( f20_arg1, f20_local1, f20_arg3 )
		end
		if not f20_local5.defaultAttachmentStats or not f20_local5.defaultModifierValues then
			f20_local5 = nil
		end
		if f20_arg6 then
			f20_arg0._weaponAttributes = {}
		end
		for f20_local13, f20_local14 in pairs( f20_local2 ) do
			local f20_local11 = f20_local7.tunedStats and f20_local7.tunedStats[f20_local13] or f20_local7.unTunedStats[f20_local13]
			if not f20_local11 or f20_local11 ~= f20_local11 then
				f20_local11 = 0
			end
			if f20_local5 and f20_local5.defaultAttachmentStats then
				local f20_local12 = f20_local5.defaultAttachmentStats
				if f20_local12[f20_local13] and f20_local12[f20_local13] == f20_local12[f20_local13] then
					f20_local11 = f20_local11 - f20_local12[f20_local13]
				end
			end
			if f20_arg6 then
				f20_arg0._weaponAttributes[f20_local13] = {
					total = f20_local14 - f20_local11,
					weapon = f20_local14 - f20_local11,
					attachment = f20_local11
				}
			else
				f20_local14.attachment = f20_local11
			end
		end
		if f20_arg6 then
			f20_arg0.StatsWithDetails.WeaponAttributes:Setup( f20_arg0._weaponAttributes, true, false )
		else
			f20_arg0.StatsWithDetails.WeaponAttributes:Update( f20_arg0._weaponAttributes )
		end
		f20_local8 = ClientWeapon[0xA41C97AC6ADDC24]( f20_arg1, f20_local4, f20_arg3 )
		if f20_local8 then
			if f20_local5 then
				GUNSMITH.ApplyDefaultModifierAdjustments( f20_local5.defaultModifierValues, f20_local8 )
			end
			if f20_arg6 then
				f20_local9 = f20_arg0.ModifiersList
				if not f20_local9 then
				
				else
					f20_local9:SetupMods( f20_local8 )
					f0_local0( f20_arg0, f20_local8, f20_arg6 )
				end
			end
			f20_local9 = f20_arg0.EquippedModifiersList
		end
	end
end

local f0_local4 = function ( f19_arg0, f19_arg1 )
	local f19_local0 = nil
	for f19_local4, f19_local5 in ddlpairs( f19_arg0.attachmentSetup ) do
		if ATTACHMENT.GetRefFromSetup( f19_local5 ) == f19_arg1 then
			f19_local0 = f19_local4 + 1
			break
		end
	end
	return f19_local0
end

local f0_local5 = function ( f18_arg0, f18_arg1 )
	local f18_local0 = 20 * _1080p
	local f18_local1 = f18_arg0:GetAnchorsAndPosition()
	local f18_local2 = f18_arg1:GetAnchorsAndPosition()
	local f18_local3 = LAYOUT.GetTextWidth( f18_arg0 )
	local f18_local4 = LAYOUT.GetTextWidth( f18_arg1 )
	if f18_local2.right < f18_local1.left + f18_local3 + f18_local4 then
		f18_arg1:SetLeft( f18_local2.right - f18_local4 )
		f18_arg0:SetRight( f18_local2.right - f18_local4 - f18_local0 )
	else
		f18_arg0:SetRight( f18_local1.left + f18_local3 )
		f18_arg1:SetLeft( f18_local1.left + f18_local3 + f18_local0 )
	end
end

local f0_local6 = function ( f17_arg0, f17_arg1, f17_arg2, f17_arg3, f17_arg4, f17_arg5 )
	DYN_ATTACHMENT.UpdateLoadoutWeaponStreamedImages( f17_arg0, f17_arg1, DYN_ATTACHMENT.StreamedImageAction.REMOVE )
	local f17_local0 = f17_arg2.attachments[f17_arg4]
	if f17_local0 then
		f17_local0 = f17_arg2.attachments[f17_arg4].variantID
	end
	table.insert( f17_arg5.menusToLeave, f17_arg0.id )
	local f17_local1 = GUNSMITH.EquipAttachment
	local f17_local2 = f17_arg0
	local f17_local3 = f17_arg1
	local f17_local4 = f17_arg5.attachToReplaceWith
	local f17_local5 = f17_arg5.weaponPlayerData
	local f17_local6 = {
		menusToLeave = f17_arg5.menusToLeave,
		attachSlot = f17_arg4,
		isNewAttachment = f17_arg5.attachToReplaceWith ~= f17_arg3,
		variantID = f17_arg5.variantID,
		lootID = f17_arg5.lootID
	}
	local f17_local7
	if f17_arg5.variantID == f17_local0 and f17_arg5.attachToReplaceWith == f17_arg3 then
		f17_local7 = false
	else
		f17_local7 = true
	end
	f17_local6.isNewVariantID = f17_local7
	f17_local1( f17_local2, f17_local3, f17_local4, f17_local5, f17_local6 )
	if f17_arg5.substituteSiblingAttachmentsToEquip then
		for f17_local3, f17_local4 in ipairs( f17_arg5.substituteSiblingAttachmentsToEquip ) do
			GUNSMITH.EquipAttachment( self, f17_arg1, f17_local4.ref, f17_arg5.weaponPlayerData, {
				attachSlot = GUNSMITH.GetSelectedAttachIndexForCategory( f17_local4.category, f17_arg2 )
			} )
		end
	end
	if CONDITIONS.IsWaveGameType() then
		Engine[0xC4146BA76D0F982]( 0x7AA312B9A84F375 )
		CP.CurrencySubtract( f17_arg1, f17_arg5.survivalCost )
		Engine[0x6055C55456F05DF]( "attachment_purchased", f17_arg5.survivalCost )
	end
	DYN_ATTACHMENT.UpdateLoadoutWeaponStreamedImages( f17_arg0, f17_arg1, DYN_ATTACHMENT.StreamedImageAction.ADD )
end

local f0_local7 = function ( f16_arg0, f16_arg1, f16_arg2, f16_arg3 )
	f16_arg1:setText( Engine[0xEB2A2834B76AEA4]( f16_arg0.name ) )
	f16_arg2:setText( f16_arg0.category )
	f16_arg3:setImage( RegisterMaterial( f16_arg0.image ) )
	f0_local0( f16_arg1, f16_arg2 )
end

local f0_local8 = function ( f15_arg0, f15_arg1, f15_arg2, f15_arg3 )
	local f15_local0 = ATTACHMENT.GetAttachmentDetails( f15_arg2 )
	f15_arg0.ChosenAttachment:UpdateContent( f15_arg2, f15_arg3 )
	ACTIONS.AnimateSequence( f15_arg0.ChosenAttachment, "Swap" )
	f0_local0( f15_local0, f15_arg0.ChosenName, f15_arg0.ChosenCategory, f15_arg0.SwapModIcon )
end

local f0_local9 = function ( f14_arg0, f14_arg1, f14_arg2, f14_arg3 )
	local f14_local0 = GL_HACK.GetWeaponMPRef( f14_arg3 )
	f14_arg0.StatsWithDetails:Setup( f14_arg1, WEAPON.GetAmmoData( f14_arg1, f14_arg2 ) )
end

local f0_local10 = function ( f12_arg0, f12_arg1, f12_arg2, f12_arg3 )
	f12_arg0.SwapAttachGrid:SetNumChildren( #f12_arg2 )
	f12_arg0.SwapAttachGrid:SetDefaultFocus( {
		x = 0,
		y = 0
	} )
	f12_arg0.SwapAttachGrid:TouchMouseSetActiveToDefaultFocusMenuCreate( f12_arg1 )
	f12_arg0.SwapAttachGrid:SetRefreshChild( function ( f13_arg0, f13_arg1, f13_arg2 )
		f13_arg0:Setup( f12_arg0[f12_arg0.SwapAttachGrid:GetContentIndex( f13_arg1, f13_arg2 ) + 1], f12_arg0 )
	end )
	f12_arg0.SwapAttachGrid:RefreshContent()
end

local f0_local11 = function ( f6_arg0, f6_arg1, f6_arg2, f6_arg3 )
	local f6_local0 = function ( f10_arg0, f10_arg1 )
		local f10_local0 = f6_arg0( f6_arg0.weaponPlayerData, f10_arg1.ref )
		local f10_local1 = f6_arg0.attachments[f10_local0]
		if f10_local1 then
			f10_local1 = f6_arg0.attachments[f10_local0].ref
		end
		assert( f10_local0 )
		local f10_local2 = ATTACHMENT.GetTableWithCurrentAttachment( f6_arg0, f10_local0, nil, f6_arg0.attachToReplaceWith, nil )
		f10_local2.attachments[f10_local0].category = ATTACHMENT.GetCategory( f6_arg0.attachToReplaceWith )
		local f10_local3 = ATTACHMENT.GetBlockedEquippedAttachments( f6_arg0, f10_local2, f10_local1, f6_arg0.allAttachments )
		local f10_local4 = ATTACHMENT.GetBlockedEquippedAttachments( f6_arg0, f10_local2, f6_arg0.attachToReplaceWith, f6_arg0.allAttachments )
		local f10_local5 = {}
		for f10_local9, f10_local10 in ipairs( f10_local3 ) do
			if not LUI.IsItemInArray( f10_local5, f10_local10 ) then
				table.insert( f10_local5, f10_local10 )
			end
		end
		for f10_local9, f10_local10 in ipairs( f10_local3 ) do
			if not LUI.IsItemInArray( f10_local5, f10_local10 ) then
				table.insert( f10_local5, f10_local10 )
			end
		end
		f6_arg0.substituteSiblingAttachmentsToEquip = {}
		for f10_local10, f10_local11 in pairs( GUNSMITH.FindSubstituteSiblingForEachAttachments( f6_arg0, f10_local2, f10_local1, f6_arg0.allAttachments, f10_local5 ) ) do
			local f10_local12 = LUI.IsItemInArray( f10_local5, f10_local10 )
			if 0 < f10_local12 then
				if f6_arg0.attachToReplaceWith ~= f10_local10.ref then
					table.insert( f6_arg0.substituteSiblingAttachmentsToEquip, f10_local11 )
				else
					f6_arg0.attachToReplaceWith = f10_local11.ref
				end
				table.remove( f10_local5, f10_local12 )
			end
		end
		if #f10_local5 == 0 then
			f6_arg0( f10_arg0, f6_arg0, f6_arg0, f10_local1, f10_local0, f6_arg0 )
		else
			LUI.FlowManager.RequestPopupMenu( nil, "PopupYesNo", false, nil, false, {
				title = Engine[0xED84C33EC5F01EA]( 0xF22B2F336C8A05C ),
				message = ATTACHMENT.AddListToBlockedMessage( Engine[0xED84C33EC5F01EA]( 0xF4F6E7738091702, #f10_local5, ATTACHMENT.GetName( f10_local1 ) ), f10_local5 ),
				yesLabel = Engine[0xED84C33EC5F01EA]( 0xF45C394F4B8A31F ),
				noLabel = Engine[0xED84C33EC5F01EA]( 0xDF4B921D6190715 ),
				yesAction = function ( f11_arg0, f11_arg1 )
					for f11_local3, f11_local4 in pairs( f10_arg0 ) do
						if f10_arg0.attachToReplaceWith ~= f11_local4.ref then
							GUNSMITH.EquipAttachment( f11_arg0, f11_arg1, ATTACHMENT.none, f10_arg0.weaponPlayerData, {
								isNewAttachment = true,
								attachSlot = GUNSMITH.GetSelectedAttachIndexForCategory( f11_local4.category, f10_arg0 )
							} )
						else
							f10_arg0.attachToReplaceWith = ATTACHMENT.none
						end
					end
					f10_arg0( f10_arg0, f11_arg1, f10_arg0, f10_arg0, f10_arg0, f10_arg0 )
				end
			}, nil, false, true )
		end
	end
	
	f6_arg0:registerEventHandler( "equip_attachment", function ( element, event )
		if GUNSMITH.IsWeaponSetupBlueprintIntact( f6_arg0.weaponPlayerData ) then
			local f7_local0 = GUNSMITH.DoesAttachmentHaveProtuning( element._weaponTable )
			if f7_local0 then
				local f7_local1 = nil
				for f7_local2 = 1, #element._weaponTable.attachments, 1 do
					if element._weaponTable.attachments[f7_local2].ref == element._equippedAttach then
						f7_local1 = element._weaponTable.attachments[f7_local2]
						break
					end
				end
				local f7_local2 = nil
				local f7_local3 = GUNSMITH.IsAttachmentProtuned( element._weaponTable, f7_local1 )
				if f7_local3 then
					f7_local2 = GUNSMITH.BlueprintEditStatus.ChangeProTunedAttachment
				elseif not f7_local3 then
					f7_local2 = GUNSMITH.BlueprintEditStatus.ChangeNonProTunedAttachment
				end
				GUNSMITH.SetupCallbackFuncForBlueprintEdit( f6_arg0, element._weaponPlayerData, f7_local2, function ()
					local f9_local0 = LUI.FlowManager.GetScopedData( LOADOUT.GetAttachmentSelectMenuRef() )
					local f9_local1 = element.Attachments._targetPosition
					if f9_local1 then
						f9_local1 = element.Attachments._targetPosition.x
					end
					f9_local0.lastTargetPositionX = f9_local1
					element( element, element )
				end )
			elseif not f7_local0 then
				GUNSMITH.SetupCallbackFuncForBlueprintEdit( f6_arg0, f6_arg0.weaponPlayerData, GUNSMITH.BlueprintEditStatus.EditBlueprint, function ()
					element( element, element )
				end )
			end
		else
			f6_arg0( element, event )
		end
		return true
	end )
end

local f0_local12 = function ( f4_arg0, f4_arg1, f4_arg2, f4_arg3, f4_arg4, f4_arg5, f4_arg6 )
	f4_arg0:registerAndCallEventHandler( "preview_attachment", function ( f5_arg0, f5_arg1 )
		local f5_local0 = f5_arg1.ref
		if not f5_local0 then
			f5_local0 = f4_arg0[1]
		end
		local f5_local1 = f4_arg0.SwapAttachGrid:GetFocusPositionIndex()
		local f5_local2 = LAYOUT.GetElementWidth( f4_arg0.ChosenAttachment )
		local f5_local3 = f4_arg0 * _1080p
		local f5_local4
		if f5_local1 and not f5_local1 then
			f5_local4 = f5_local1
		else
			f5_local4 = 0
		end
		f5_local3 = f5_local3 + f5_local4 * (f4_arg0 + f5_local2)
		f5_local4 = f5_local3 + f5_local2
		if CONDITIONS.IsSplitscreen( f4_arg0 ) and CONDITIONS.InGame( f4_arg0 ) then
			f4_arg0.ChosenAttachment:SetAnchorsAndPosition( 0, 1, 0, 1, f5_local3, f5_local4, _1080p * 300, _1080p * 400 )
		else
			f4_arg0.ChosenAttachment:SetAnchorsAndPosition( 0, 1, 0, 1, f5_local3, f5_local4, _1080p * 516, _1080p * 616 )
		end
		local f5_local5 = LUI.DeepCopy( f4_arg0 )
		local f5_local6 = f5_local5.attachments
		local f5_local7 = f4_arg0( f4_arg0, f5_local0 )
		if f5_local7 == nil then
			return 
		end
		for f5_local11, f5_local12 in ipairs( f5_local6 ) do
			if f5_local12.ref == f5_local0 then
				f5_local12.ref = f4_arg0
			end
		end
		f5_local5.attachments = f5_local6
		f5_local8 = f4_arg0.attachments[f5_local7].ref
		f4_arg0( ATTACHMENT.GetAttachmentDetails( f5_local8 ), f4_arg0.EquippedName, f4_arg0.EquippedCategory, f4_arg0.EquippedModIcon )
		f4_arg0( f4_arg0, f4_arg0, f5_local0, Engine[0x603B6AC5797050A]( WEAPON.GetWeaponModelNameFromPlayerData( f4_arg0, f4_arg0, {
			includeAttachments = true
		} ), f5_local8 ), f5_local7, f5_local5, false )
	end )
end

local f0_local13 = function ( f3_arg0, f3_arg1, f3_arg2 )
	assert( f3_arg2.weaponPlayerData )
	assert( f3_arg2.attachToReplaceWith )
	assert( f3_arg0.ChosenAttachment.Image )
	assert( f3_arg0.ChosenAttachment.Category )
	assert( f3_arg0.ChosenAttachment.Name )
	local f3_local0 = f3_arg2.weaponPlayerData.weapon:get()
	local f3_local1 = WEAPON.GenerateWeaponTable( f3_arg2.weaponPlayerData )
	local f3_local2 = ATTACHMENT.GetRef( f3_arg2.attachToReplaceWith, f3_local0 )
	local f3_local3 = GUNSMITH.GetAttachmentRefsByType( ATTACHMENT.GetCategory( f3_local2 ), f3_arg2.weaponPlayerData )
	local f3_local4 = Engine[0x603B6AC5797050A]( WEAPON.GetWeaponModelNameFromPlayerData( f3_local0, f3_arg2.weaponPlayerData, {
		includeAttachments = true
	} ), f3_local2 )
	local f3_local5 = WEAPON.FindAttachmentRefInAttachmentsTable( f3_local1, f3_local2 )
	f0_local0( f3_arg0, f3_arg1, f3_local2, f3_local0 )
	f0_local0( f3_arg0, f3_arg1, f3_local2, f3_local4, f3_local5, f3_local1, true )
	f0_local0( f3_arg0, f3_arg1, f3_local1, f3_local0 )
	f0_local0( f3_arg0, f3_arg1, f3_local3, f3_local0 )
	f0_local0( f3_arg0, f3_arg1, f3_arg2, f3_local1 )
	f0_local0( f3_arg0, f3_arg1, f3_arg2.weaponPlayerData, f3_local1, f3_local3, f3_local2, f3_local0 )
end

local f0_local14 = function ( f2_arg0, f2_arg1, f2_arg2 )
	f2_arg0.PostLoadShared = f0_local0
end

function SwapAttachmentPopupBase( menu, controller )
	local self = LUI.UIElement.new()
	self.id = "SwapAttachmentPopupBase"
	local f1_local1
	if controller then
		f1_local1 = controller
	else
		f1_local1 = controller.controllerIndex
	end
	f1_local1 = LUI.ValidateControllerIndex( self, f1_local1 )
	local f1_local2 = self
	f0_local0( self, f1_local1, controller )
	return self
end

MenuBuilder.registerType( "SwapAttachmentPopupBase", SwapAttachmentPopupBase )
LockTable( _M )
