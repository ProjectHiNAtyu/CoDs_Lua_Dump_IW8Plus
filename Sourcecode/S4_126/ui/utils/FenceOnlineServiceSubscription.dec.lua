-- Generated by CoDLuaDecompiler
-- Version: 2.4.2
-- Date: 04-10-2025 21:42
module( ..., package.seeall )
FenceOnlineServiceSubscription = LUI.Class( LUI.Fence )
FenceOnlineServiceSubscription.UPSELL_STATE = {
	done = 3,
	selling = 2,
	inactive = 1
}
FenceOnlineServiceSubscription.init = function ( f14_arg0 )
	LUI.Fence.init( f14_arg0 )
	f14_arg0._perController = {}
	for f14_local0 = 0, Engine[0xB686A0A723E6442]() - 1, 1 do
		f14_arg0._perController[f14_local0] = {
			onlineUpsell = FenceOnlineServiceSubscription.UPSELL_STATE.inactive
		}
	end
	f14_arg0._isShowingBlockingPopup = false
end

FenceOnlineServiceSubscription.Start = function ( f13_arg0 )
	DebugPrint( "FenceOnlineServiceSubscription.Start" )
	if f13_arg0._isShowingBlockingPopup then
		LUI.FlowManager.RequestLeaveMenuByName( "OnlineSubscriptionInfoPopup", true )
		f13_arg0._isShowingBlockingPopup = false
	end
end

FenceOnlineServiceSubscription.Stop = function ( f12_arg0 )
	DebugPrint( "FenceOnlineServiceSubscription.Stop" )
	if f12_arg0._isShowingBlockingPopup then
		LUI.FlowManager.RequestLeaveMenuByName( "OnlineSubscriptionInfoPopup", true )
		f12_arg0._isShowingBlockingPopup = false
	end
end

FenceOnlineServiceSubscription.PostFail = function ( f11_arg0 )
	if f11_arg0._state == LUI.Fence.STATE.fail then
		LUI.FlowManager.RequestPopupMenu( nil, "NoOnlineServiceSubscriptionErrorPopup", false, nil, false, {
			controllerIndex = Engine[0x45B054C920178E9]()
		}, nil, false, true )
	end
end

FenceOnlineServiceSubscription.OnBackOut = function ( f10_arg0 )
	DebugPrint( "FenceOnlineServiceSubscription.OnBackOut" )
	Engine[0x7C75E608EA39B5C]( "xcancelinvitejoin", Engine[0x45B054C920178E9]() )
	if Engine[0xCBCF315DE9B8AC6] and not Lobby[0x867E2628CAA1981]() then
		Engine[0xB81A5136C5503E4]( "xstopparty" )
	end
	if Lobby[0x63537242F1D48FF]() and not Lobby[0x6957722EF74F5D2]() then
		Engine[0xB81A5136C5503E4]( "xstopprivateparty" )
		Engine[0xB81A5136C5503E4]( "xstartprivateparty" )
	end
end

FenceOnlineServiceSubscription.UpdateState = function ( f9_arg0 )
	assert( f9_arg0._state ~= LUI.Fence.STATE.fail )
	f9_arg0._state = LUI.Fence.STATE.pass
	for f9_local0 = 0, Engine[0xB686A0A723E6442]() - 1, 1 do
		if Engine[0x10A5732AB1DAE9F]( f9_local0 ) then
			if Engine[0x810854172EF3376]( f9_local0 ) then
				if not Engine[0xDA7A89CE2B1A2CA]( f9_local0 ) then
					if f9_arg0._perController[f9_local0].onlineUpsell == FenceOnlineServiceSubscription.UPSELL_STATE.inactive then
						f9_arg0._perController[f9_local0].onlineUpsell = FenceOnlineServiceSubscription.UPSELL_STATE.selling
						f9_arg0._state = LUI.Fence.STATE.block
						Engine[0x649973B27FFBB2]( f9_local0 )
						break
					end
					local f9_local3 = f9_arg0._perController[f9_local0].onlineUpsell == FenceOnlineServiceSubscription.UPSELL_STATE.selling
					if Engine[0x8CF5A323493AFE2]() then
						f9_arg0._state = LUI.Fence.STATE.block
						break
					elseif f9_local3 then
						f9_arg0._perController[f9_local0].onlineUpsell = FenceOnlineServiceSubscription.UPSELL_STATE.done
						f9_arg0._state = LUI.Fence.STATE.fail
					end
				end
				f9_arg0._perController[f9_local0].onlineUpsell = FenceOnlineServiceSubscription.UPSELL_STATE.inactive
			end
			f9_arg0._state = LUI.Fence.STATE.block
			if not f9_arg0._isShowingBlockingPopup then
				f9_arg0:OpenPopupWaitingForOnlineSubsciptionInfo()
			end
		end
		f9_arg0._perController[f9_local0].onlineUpsell = FenceOnlineServiceSubscription.UPSELL_STATE.inactive
	end
end

function GetErrorMessageButtons( f4_arg0, f4_arg1 )
	local f4_local0 = false
	if not f4_arg1 then
		f4_arg1 = not Engine[0x8B495DC361731F7]( f4_arg0 )
		if f4_arg1 then
			f4_local0 = true
		end
	end
	local f4_local1 = {
		label = Engine[0xED84C33EC5F01EA]( "MENU/OK" ),
		action = function ( f8_arg0, f8_arg1 )
			LUI.FlowManager.RequestLeaveMenu( f8_arg0:GetCurrentMenu(), true )
		end
	}
	local f4_local2 = {
		label = Engine[0xED84C33EC5F01EA]( "MENU/GO_OFFLINE" ),
		action = function ( f7_arg0, f7_arg1 )
			Dvar[0x8EA06EEDB58D872]( "#x3a19e842a39482ea0", false )
			Engine[0x4B0C2D659AE39D3]( "Going Offline", f4_arg0 )
			Engine[0xB81A5136C5503E4]( "xstopprivateparty" )
			Engine[0xB81A5136C5503E4]( "xstartprivateparty" )
			LUI.FlowManager.RequestLeaveMenu( f7_arg0:GetCurrentMenu(), true )
			LUI.FlowManager.RequestAddMenu( LUI.FlowManager.MainMenuOffline, false, f4_arg0 )
		end
	}
	local f4_local3 = {
		label = Engine[0xED84C33EC5F01EA]( "MENU/EXIT" ),
		action = function ( f6_arg0, f6_arg1 )
			LUI.FlowManager.RequestRestoreMenu( "MainLockoutMenu", true, f6_arg1.controller )
		end
	}
	if f4_local0 then
		local f4_local4 = self:Wait( 1000 )
		f4_local4.onComplete = function ()
			f4_arg0 = not Engine[0x8B495DC361731F7]( f4_arg0 )
			return {
				f4_arg0,
				f4_arg0 and f4_arg0 or f4_arg0
			}
		end
		
		
	end
	local f4_local4 = {
		f4_local1
	}
	local f4_local5
	if f4_arg1 and not f4_local3 then
		f4_local5 = f4_local3
	else
		f4_local5 = f4_local2
	end
	f4_local4[2] = f4_local5
	return f4_local4
end

function NoOnlineServiceSubscriptionErrorPopup( f3_arg0, f3_arg1 )
	assert( f3_arg1 )
	local f3_local0 = nil
	if Engine[0x836C8AD984F14F6]() then
		f3_local0 = "PLATFORM/PSPLUS_REQUIRED"
	else
		f3_local0 = "XBOXLIVE/MPNOTALLOWED"
	end
	assert( f3_local0 )
	local f3_local1 = {
		controllerIndex = f3_arg1.controllerIndex,
		title = Engine[0xED84C33EC5F01EA]( "MENU/CONNECTION_FAILED" ),
		message = Engine[0xED84C33EC5F01EA]( f3_local0 )
	}
	local f3_local2 = not Engine[0xCA404C71196D651]( f3_arg1.controllerIndex )
	if f3_local2 then
		f3_local1.message = Engine[0xED84C33EC5F01EA]( "LUA_MENU/N_NEWLINE_M", Engine[0x7D3158A9539A355]( Engine[0x29680E4E30C45C2]( f3_arg1.controllerIndex ) ), f3_local1.message )
	end
	if f3_local2 then
		f3_local1.buttons = BOOT.GetOkayPopupButtons()
	else
		f3_local1.buttons = GetErrorMessageButtons( f3_arg1.controllerIndex )
	end
	local f3_local3 = MenuBuilder.BuildRegisteredType( "GenericImagePopup", f3_local1 )
	f3_local3.id = "NoOnlineServiceSubscriptionErrorPopup"
	return f3_local3
end

FenceOnlineServiceSubscription.OpenPopupWaitingForOnlineSubsciptionInfo = function ( f2_arg0 )
	LUI.FlowManager.RequestPopupMenu( nil, "OnlineSubscriptionInfoPopup", false, nil, false, args, nil, true, true )
	f2_arg0._isShowingBlockingPopup = true
end

function OpenPopupWaitingForOnlineSubsciptionInfo( f1_arg0, f1_arg1 )
	local f1_local0 = MenuBuilder.BuildRegisteredType( "LiveTextboxPopup", {
		message = Engine[0xED84C33EC5F01EA]( "MENU/WAITING_FOR_ONLINE_SUBSCRIPTION_INFO" )
	} )
	f1_local0.id = "OnlineSubscriptionInfoPopup"
	return f1_local0
end

MenuBuilder.registerType( "OnlineSubscriptionInfoPopup", OpenPopupWaitingForOnlineSubsciptionInfo )
MenuBuilder.registerType( "NoOnlineServiceSubscriptionErrorPopup", NoOnlineServiceSubscriptionErrorPopup )
LUI.Fence.Register( "onlineServiceSubscription", FenceOnlineServiceSubscription )
LockTable( _M )
