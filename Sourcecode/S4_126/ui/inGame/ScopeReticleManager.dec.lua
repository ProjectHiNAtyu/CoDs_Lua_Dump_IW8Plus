-- Generated by CoDLuaDecompiler
-- Version: 2.4.2
-- Date: 04-10-2025 21:42
module( ..., package.seeall )
local f0_local0 = 10
local f0_local1 = 1
local f0_local2 = 2
local f0_local3 = function ( f28_arg0, f28_arg1, f28_arg2, f28_arg3, f28_arg4, f28_arg5, f28_arg6, f28_arg7, f28_arg8, f28_arg9, f28_arg10, f28_arg11, f28_arg12 )
	if not MenuBuilder.IsTypeRegistered( f28_arg1 ) then
		DebugPrint( "ERROR: Attempting to use unknown widget " .. f28_arg1 .. ". Ensure this widget is properly included for your game mode!" )
		return nil
	end
	local f28_local0 = MenuBuilder.BuildRegisteredType( f28_arg1, {
		controllerIndex = f28_arg3
	} )
	local f28_local1 = {
		entityTag = f28_arg2,
		isLockedToTag = f28_arg6,
		tagOffsetX = f28_arg7,
		naturalDistance = f28_arg8,
		naturalFOV = f28_arg9,
		defaultScale = f28_arg10,
		minScale = f28_arg11,
		maxScale = f28_arg12
	}
	f28_local0.id = "weaponWidget" .. f28_arg1
	f28_local0:SetupAnchoredElement( f28_local1 )
	if f28_arg4 then
		f28_local0:AttachToReticleViewModel()
	else
		f28_local0:AttachToViewModel( f28_arg5 )
	end
	f28_arg0:addElement( f28_local0 )
	return f28_local0
end

local f0_local4 = function ( f27_arg0, f27_arg1, f27_arg2 )
	if not MenuBuilder.IsTypeRegistered( f27_arg2 ) then
		DebugPrint( "ERROR: Attempting to use unknown widget " .. f27_arg2 .. ". Ensure this widget is properly included for your game mode!" )
		return nil
	else
		local f27_local0 = MenuBuilder.BuildRegisteredType( f27_arg2, {
			controllerIndex = f27_arg1
		} )
		f27_local0.id = "crosshairWidget" .. f27_arg2
		f27_local0:SetAnchors( 0, 0, 0, 0, 0 )
		f27_local0:SetupDynamicCrosshair()
		f27_arg0:addElement( f27_local0 )
		return f27_local0
	end
end

local f0_local5 = function ( f26_arg0, f26_arg1, f26_arg2 )
	assert( f26_arg2.isPrimary ~= nil )
	assert( f26_arg2.isAlternate ~= nil )
	assert( f26_arg2.reticleIndex )
	local f26_local0 = "tag_reticle_attach"
	if f26_arg2.isAlternate then
		f26_local0 = "tag_reticle_attach2"
	end
	local f26_local1 = f26_arg0.reticleNames
	local f26_local2
	if f26_arg2.isAlternate then
		f26_local2 = 2
	else
		f26_local2 = 1
	end
	f26_local1 = f26_local1[f26_local2] ~= f26_arg2.reticleName
	if f26_arg0.reticles[f26_arg2.reticleIndex] and f26_local1 then
		f26_arg0.reticles[f26_arg2.reticleIndex]:closeTree()
		f26_arg0.reticles[f26_arg2.reticleIndex] = nil
	end
	if f26_arg2.reticleType ~= nil and 0 < #f26_arg2.reticleType and f26_local1 then
		f26_local2, f26_local3, f26_local4, f26_local5 = nil
		if f26_arg2.isPrimary then
			f26_local2 = Game[0x23742A69D7F5825]( f26_arg1, f26_arg2.isAlternate )
			f26_local5 = Game[0x13F7AE89DFC6E16]( f26_arg1, f26_arg2.isAlternate )
			if Game[0xCD0510EC63A89E4]( f26_arg1, f26_arg2.isAlternate ) then
				f26_local3 = Game[0x15A6B7714FD0AD9]( f26_arg1, f26_arg2.isAlternate )
			end
			f26_local4 = Game[0xFE4A5D4DCA4A4A8]( f26_arg1, f26_arg2.isAlternate )
		else
			f26_local2 = Game[0xC73A641E79EA3B9]( f26_arg1, f26_arg2.isAlternate )
			f26_local5 = Game[0x363F203268F2372]( f26_arg1, f26_arg2.isAlternate )
			f26_local4 = Game[0x2525D75712F8AC0]( f26_arg1, f26_arg2.isAlternate )
		end
		f26_arg0.reticles[f26_arg2.reticleIndex] = f0_local0( f26_arg0, f26_arg2.reticleType, f26_local0, f26_arg1, true, true, f26_local2, f26_local5, Game[0xC64ABFE83750AD5]( f26_arg1, f26_arg2.isAlternate ), f26_local3, f26_local4, Game[0xE9F5513A2E6BE7F]( f26_arg1, f26_arg2.isAlternate ), Game[0x35F2FC1A4A30C05]( f26_arg1, f26_arg2.isAlternate ) )
	end
end

local f0_local6 = function ( f25_arg0, f25_arg1, f25_arg2 )
	local f25_local0 = nil
	local f25_local1 = false
	if f25_arg2 ~= nil and 0 < #f25_arg2 then
		f25_local0 = Game[0x452777EC5FA7DD5]( f25_arg1 )
		f25_local1 = Game[0xD1C271BEBA20F99]( f25_arg1, f25_local0 )
	end
	local f25_local2 = f25_arg0.weaponWidgetType ~= f25_arg2
	if f25_arg0.weaponWidget and (f25_local2 or (f25_arg0.weaponWidgetBone ~= f25_local0) or not f25_local1) then
		f25_arg0.weaponWidget:closeTree()
		f25_arg0.weaponWidget = nil
	end
	if f25_arg2 ~= nil and 0 < #f25_arg2 and f25_local2 and f25_local1 then
		f25_arg0.weaponWidget = f0_local0( f25_arg0, f25_arg2, f25_local0, f25_arg1, false, Game[0xCBB6EBCF8D8D4AB]( f25_arg1 ), true, nil, f0_local0, nil, f0_local0, f0_local0 )
		f25_arg0.weaponWidgetType = f25_arg2
		f25_arg0.weaponWidgetBone = f25_local0
	else
		f25_arg0.weaponWidgetType = nil
		f25_arg0.weaponWidgetBone = nil
	end
end

local f0_local7 = function ( f24_arg0, f24_arg1, f24_arg2 )
	if f24_arg0.maxNumAttachments ~= f24_arg2 then
		return true
	elseif not f24_arg0.attachmentsInfo then
		return true
	end
	local f24_local0 = 0
	for f24_local1 = 0, f24_arg2 - 1, 1 do
		local f24_local4 = Game[0x1CE94E268E8474D]( f24_arg1, f24_local1 )
		local f24_local5 = Game[0xCE362F53EEDC7AE]( f24_arg1, f24_local1 )
		local f24_local6 = Game[0xE9123A0DB7B03D6]( f24_arg1, f24_local1 )
		if f24_local4 ~= nil and 0 < #f24_local4 then
			f24_local0 = f24_local0 + 1
			if not f24_arg0.attachmentsInfo[f24_local0] then
				return true
			end
			if (f24_local4 ~= f24_arg0.attachmentsInfo[f24_local0].widgetType) or (f24_local5 ~= f24_arg0.attachmentsInfo[f24_local0].widgetAttachPoint) or f24_local6 ~= f24_arg0.attachmentsInfo[f24_local0].widgetUsesScopeStencil then
				return true
			end
		end
	end
	if f24_local0 ~= #f24_arg0.attachmentsList then
		return true
	end
	return false
end

local f0_local8 = function ( f23_arg0, f23_arg1, f23_arg2 )
	if f23_arg0.attachmentsList then
		for f23_local3, f23_local4 in ipairs( f23_arg0.attachmentsList ) do
			f23_arg0.attachmentsList[f23_local3]:closeTree()
			f23_arg0.attachmentsList[f23_local3] = nil
		end
	end
	f23_arg0.attachmentsList = nil
	f23_arg0.attachmentsInfo = nil
	f23_arg0.attachmentsList = {}
	f23_arg0.attachmentsInfo = {}
	f23_arg0.maxNumAttachments = f23_arg2
	for f23_local0 = 0, f23_arg2 - 1, 1 do
		local f23_local4 = Game[0x1CE94E268E8474D]( f23_arg1, f23_local0 )
		local f23_local5 = Game[0xCE362F53EEDC7AE]( f23_arg1, f23_local0 )
		local f23_local6 = Game[0xE9123A0DB7B03D6]( f23_arg1, f23_local0 )
		if f23_local4 ~= nil and 0 < #f23_local4 then
			f23_arg0.attachmentsList[#f23_arg0.attachmentsList + 1] = f0_local0( f23_arg0, f23_local4, f23_local5, f23_arg1, false, f23_local6, true, nil, f0_local0, nil, f0_local0, f0_local0 )
			f23_arg0.attachmentsInfo[#f23_arg0.attachmentsInfo + 1] = {
				widgetType = f23_local4,
				widgetAttachPoint = f23_local5,
				widgetUsesScopeStencil = f23_local6
			}
		end
	end
end

local f0_local9 = function ( f22_arg0, f22_arg1, f22_arg2 )
	if f22_arg2 ~= nil and 0 < #f22_arg2 then
		if f22_arg0.crosshairWidget then
			f22_arg0.crosshairWidget:closeTree()
			f22_arg0.crosshairWidget = nil
		end
		if f22_arg0.previousCrosshairWidget then
			if f22_arg0.previousCrosshairWidgetType == f22_arg2 then
				f22_arg0.crosshairWidget = f22_arg0.previousCrosshairWidget
				f22_arg0:addElement( f22_arg0.crosshairWidget )
			else
				f22_arg0.previousCrosshairWidget:closeTree()
			end
			f22_arg0.previousCrosshairWidget = nil
			f22_arg0.previousCrosshairWidgetType = nil
		end
		if f22_arg0.crosshairWidget == nil then
			f22_arg0.crosshairWidget = f0_local0( f22_arg0, f22_arg1, f22_arg2 )
		end
	elseif f22_arg0.crosshairWidget then
		f22_arg0:RemoveElement( f22_arg0.crosshairWidget )
		f22_arg0.previousCrosshairWidget = f22_arg0.crosshairWidget
		f22_arg0.previousCrosshairWidgetType = f22_arg0.crosshairWidgetType
		f22_arg0.crosshairWidget = nil
	end
	f22_arg0.crosshairWidgetType = f22_arg2
end

local f0_local10 = function ( f21_arg0, f21_arg1 )
	local f21_local0 = DataSources.inGame.player.currentWeapon.primaryReticleVisible:GetValue( f21_arg1 )
	local f21_local1 = DataSources.inGame.player.currentWeapon.altReticleVisible:GetValue( f21_arg1 )
	local f21_local2 = DataSources.inGame.player.currentWeapon.weaponInfoLUIWidgetsVisible:GetValue( f21_arg1 )
	local f21_local3 = DataSources.inGame.player.currentWeapon.hipfireCrosshairVisible:GetValue( f21_arg1 )
	if f21_local1 and not f21_local0 and not f21_arg0.reticles[3] then
		f21_local0 = true
		f21_local1 = false
	end
	if f21_arg0.reticles[1] then
		local f21_local4 = f21_arg0.reticles[1]
		local f21_local5 = f21_local4
		f21_local4 = f21_local4.SetAlpha
		local f21_local6
		if f21_local0 then
			f21_local6 = 1
		else
			f21_local6 = 0
		end
		f21_local4( f21_local5, f21_local6, 0 )
	end
	if f21_arg0.reticles[3] then
		local f21_local4 = f21_arg0.reticles[3]
		local f21_local5 = f21_local4
		f21_local4 = f21_local4.SetAlpha
		local f21_local6
		if f21_local1 then
			f21_local6 = 1
		else
			f21_local6 = 0
		end
		f21_local4( f21_local5, f21_local6, 0 )
	end
	if f21_arg0.weaponWidget then
		local f21_local4 = f21_arg0.weaponWidget
		local f21_local5 = f21_local4
		f21_local4 = f21_local4.SetAlpha
		local f21_local6
		if f21_local2 then
			f21_local6 = 1
		else
			f21_local6 = 0
		end
		f21_local4( f21_local5, f21_local6, 0 )
	end
	if f21_arg0.attachmentsList then
		for f21_local6, f21_local9 in ipairs( f21_arg0.attachmentsList ) do
			local f21_local10 = f21_arg0.attachmentsList[f21_local6]
			local f21_local11 = f21_local10
			f21_local10 = f21_local10.SetAlpha
			local f21_local8
			if f21_local2 then
				f21_local8 = 1
			else
				f21_local8 = 0
			end
			f21_local10( f21_local11, f21_local8, 0 )
		end
	end
	if f21_arg0.crosshairWidget then
		if Dvar[0x9E5BE3B4BBA4E0E]( "#x3ed852b5512d431cd" ) then
			f21_local3 = false
		end
		local f21_local4 = f21_arg0.crosshairWidget
		local f21_local5 = f21_local4
		f21_local4 = f21_local4.SetAlpha
		local f21_local6
		if f21_local3 then
			f21_local6 = 1
		else
			f21_local6 = 0
		end
		f21_local4( f21_local5, f21_local6, 0 )
	end
end

local f0_local11 = function ( f20_arg0 )
	f20_arg0.reticleShakeProperties = {}
	f20_arg0.defaultReticleShakeProperties = {
		numRapidFireBullets = 1,
		multiplier = 1,
		magnitude = 0,
		settleDuration = 0,
		duration = 0
	}
	f20_arg0.reticleShake = {
		timer = 0,
		minMagnitude = 0,
		epsilon = 1.9991592787261236E+37,
		currentNumBullets = 0,
		maxMagnitude = 60,
		burstFireResetTime = 600
	}
end

local f0_local12 = function ( f19_arg0 )
	local f19_local0 = f19_arg0.reticleShakeProperties.magnitude
	if f19_arg0.reticleShakeProperties.numRapidFireBullets < f19_arg0.reticleShake.currentNumBullets then
		f19_local0 = f19_local0 * f19_arg0.reticleShakeProperties.multiplier
	end
	local f19_local1 = LUI.Lerp( f19_arg0.reticleShake.minMagnitude, f19_arg0.reticleShake.maxMagnitude, f19_local0 ) * math.random()
	local f19_local2 = math.random() * 2 * math.pi
	f19_arg0.reticles[1]:SetScreenOffsets( f19_local1 * math.cos( f19_local2 ), f19_local1 * math.sin( f19_local2 ) )
end

local f0_local13 = function ( f18_arg0 )
	if not f18_arg0.reticles[1] then
		return 
	end
	local f18_local0 = Game[0x49FC972008AE526]()
	local f18_local1 = f18_local0 - f18_arg0.previousTime
	if f18_arg0.reticleShake.burstFireResetTime < f18_local0 - f18_arg0.lastShotFiredTime then
		f18_arg0.reticleShake.currentNumBullets = 0
	end
	if 0 < f18_arg0.reticleShake.timer then
		f18_arg0.reticleShake.timer = f18_arg0.reticleShake.timer - f18_local1
		f0_local0( f18_arg0 )
	else
		f18_arg0.reticleShake.timer = 0
		local f18_local2 = f18_arg0.reticles[1]:GetScreenOffsets()
		if math.abs( f18_local2.x ) <= f18_arg0.reticleShake.epsilon and math.abs( f18_local2.y ) <= f18_arg0.reticleShake.epsilon then
			f18_arg0.reticles[1]:SetScreenOffsets( 0, 0 )
			return 
		end
		local f18_local3 = 1
		if 0 < f18_arg0.reticleShakeProperties.settleDuration then
			f18_local3 = (f18_local0 - f18_arg0.lastShotFiredTime) / f18_arg0.reticleShakeProperties.settleDuration
		end
		f18_local3 = LUI.clamp( f18_local3, 0, 1 )
		f18_local2.x = LUI.Lerp( f18_local2.x, 0, f18_local3 )
		f18_local2.y = LUI.Lerp( f18_local2.y, 0, f18_local3 )
		f18_arg0.reticles[1]:SetScreenOffsets( f18_local2.x, f18_local2.y )
	end
	f18_arg0.previousTime = f18_local0
end

local f0_local14 = function ( f17_arg0 )
	if not f17_arg0.reticles[1] then
		return 
	end
	f17_arg0.reticleShake.currentNumBullets = f17_arg0.reticleShake.currentNumBullets + 1
	if f17_arg0.reticleShake.timer <= 0 then
		f17_arg0.reticleShake.timer = f17_arg0.reticleShakeProperties.duration
	end
end

local f0_local15 = function ( f16_arg0 )
	f0_local0( f16_arg0 )
end

local f0_local16 = nil
f0_local16 = function ( f14_arg0, f14_arg1 )
	local f14_local0 = f14_arg0:Wait( 50 )
	f0_local0( f14_arg0 )
	f14_local0.onComplete = function ()
		return f14_arg0( f14_arg0, f14_arg0 )
	end
	
end

local f0_local17 = function ( f13_arg0, f13_arg1 )
	f13_arg0.lastShotFiredTime = Game[0x49FC972008AE526]()
	f0_local0( f13_arg0 )
end

function ScopeReticleManager()
	local self = LUI.UIElement.new()
	self.id = "ScopeReticleManager"
	self.reticles = {}
	self.reticleNames = {}
	local f1_local1 = self:getRootController()
	local f1_local2 = LUI.DataSourceInControllerModel.new( "cg.player.currentWeapon.crosshairWidget" )
	f1_local2 = f1_local2:GetModel( f1_local1 )
	f0_local0( self )
	self.previousTime = 0
	self.lastShotFiredTime = 0
	self:addEventHandler( "post_restart", function ( f12_arg0, f12_arg1 )
		f12_arg0.previousTime = 0
		f12_arg0.lastShotFiredTime = 0
		self.reticleShake.timer = 0
	end )
	local f1_local3 = function ( f11_arg0 )
		local f11_local0 = DataModel[0x614D394F6F9A18D]( f11_arg0 )
		if f11_local0 ~= nil and f11_local0 ~= 0 then
			self.previousTime = 0
			self.lastShotFiredTime = 0
			self.reticleShake.timer = 0
		end
	end
	
	local f1_local4 = function ()
		if Dvar[0x9E5BE3B4BBA4E0E]( "#x3bb2e06993cd4bdc" ) then
			local f10_local0 = Game[0x65D4365B16E06F]( self, false )
			local f10_local1 = Game[0x6893E8D5F9CA3BB]( self, false )
			local f10_local2 = Game[0x565048F9E3C3A64]( self, false )
			local f10_local3, f10_local4, f10_local5 = nil
			f10_local3 = Game[0x65D4365B16E06F]( self, true )
			f10_local4 = Game[0x6893E8D5F9CA3BB]( self, true )
			f10_local5 = Game[0x565048F9E3C3A64]( self, true )
			local f10_local6 = Game[0x735409EE1DF2D7C]( self )
			local f10_local7 = Game[0x445EA93E7254041]( self )
			local f10_local8 = DataModel[0x614D394F6F9A18D]( self )
			local f10_local9 = self( self, self, f10_local7 )
			self( self, self, {
				isAlternate = false,
				reticleIndex = 1,
				isPrimary = true,
				reticleType = f10_local0,
				reticleName = f10_local2
			} )
			self( self, self, {
				isAlternate = false,
				reticleIndex = 2,
				isPrimary = false,
				reticleType = f10_local1,
				reticleName = f10_local2
			} )
			self.reticleNames[1] = f10_local2
			self( self, self, {
				isAlternate = true,
				reticleIndex = 3,
				isPrimary = true,
				reticleType = f10_local3,
				reticleName = f10_local5
			} )
			self( self, self, {
				isAlternate = true,
				reticleIndex = 4,
				isPrimary = false,
				reticleType = f10_local4,
				reticleName = f10_local5
			} )
			self.reticleNames[2] = f10_local5
			self( self, self, f10_local6 )
			local f10_local10 = self
			local f10_local11 = Game[0x7C67187E6F52B84]( self )
			if not f10_local11 then
				f10_local11 = self.defaultReticleShakeProperties
			end
			f10_local10.reticleShakeProperties = f10_local11
			if f10_local9 then
				self( self, self, f10_local7 )
			end
			if self.crosshairWidgetType ~= f10_local8 then
				self( self, self, f10_local8 )
			end
			self( self, self )
		end
	end
	
	local f1_local5 = DataSources.inGame.player.currentWeapon.scopeVariation
	local f1_local6 = DataSources.inGame.player.currentWeapon.scopeIndex
	local f1_local7 = DataSources.inGame.player.currentWeapon.displayName
	local f1_local8 = DataSources.inGame.player.currentWeapon.isDefaultWeapon
	local f1_local9 = DataSources.inGame.player.currentWeapon.isNull
	if Engine[0x74423E76DECE3E4]() then
		self:SubscribeToModel( DataSources.inGame.SP.deathHint.deathQuote:GetModel( f1_local1 ), f1_local3 )
	end
	if Engine[0x9258F49F515F97B]() then
		self:SubscribeToModel( DataSources.inGame.player.inKillCam:GetModel( f1_local1 ), f1_local3 )
	end
	self:SubscribeToModel( f1_local5:GetModel( f1_local1 ), f1_local4, true )
	self:SubscribeToModel( f1_local6:GetModel( f1_local1 ), f1_local4, true )
	self:SubscribeToModel( f1_local7:GetModel( f1_local1 ), f1_local4, true )
	self:SubscribeToModel( f1_local8:GetModel( f1_local1 ), f1_local4, true )
	self:SubscribeToModel( f1_local2, f1_local4, true )
	self:SubscribeToModel( f1_local9:GetModel( f1_local1 ), f1_local4, true )
	self:SubscribeToModel( DataSources.inGame.player.currentWeapon.shotCounter:GetModel( f1_local1 ), function ()
		self( self, self )
	end, true )
	self:SubscribeToModel( DataSources.inGame.player.currentWeapon.primaryReticleVisible:GetModel( f1_local1 ), function ()
		self( self, self )
	end, true )
	self:SubscribeToModel( DataSources.inGame.player.currentWeapon.altReticleVisible:GetModel( f1_local1 ), function ()
		self( self, self )
	end, true )
	self:SubscribeToModel( DataSources.inGame.player.currentWeapon.weaponInfoLUIWidgetsVisible:GetModel( f1_local1 ), function ()
		self( self, self )
	end, true )
	self:SubscribeToModel( DataSources.inGame.player.currentWeapon.hipfireCrosshairVisible:GetModel( f1_local1 ), function ()
		self( self, self )
	end, true )
	local f1_local10 = LUI.DataSourceInControllerModel.new( "cg.player.currentWeapon.inWorldAttachmentsAlpha" )
	self:BindAlphaToModel( f1_local10:GetModel( f1_local1 ) )
	self:SubscribeToModel( DataSources.inGame.player.affectedByEMP:GetModel( f1_local1 ), function ( f4_arg0 )
		if DataModel[0x614D394F6F9A18D]( f4_arg0 ) then
			self:SetGlitchAmount( 1 )
		else
			self:SetGlitchAmount( 0 )
		end
	end )
	if Engine[0xD151EC5B41223B5]() and CONDITIONS.IsScrambleHUDEnabled() then
		local f1_local11 = LUI.DataSourceFromOmnvar.new( "ui_scrambler_strength" )
		self:SubscribeToModel( f1_local11:GetModel( f1_local1 ), function ()
			self:SetGlitchAmount( self:GetValue( self ) * 0.2 )
		end )
	end
	f1_local4()
	local f1_local11 = self:Wait( 50 )
	f1_local11.onComplete = function ()
		return self( self, self )
	end
	
	return self
end

MenuBuilder.registerType( "ScopeReticleManager", ScopeReticleManager )
LockTable( _M )
