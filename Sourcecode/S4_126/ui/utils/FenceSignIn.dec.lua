-- Generated by CoDLuaDecompiler
-- Version: 2.4.2
-- Date: 04-10-2025 21:42
module( ..., package.seeall )
FenceSignIn = LUI.Class( LUI.Fence )
FenceSignIn.ACCOUNT_PICKER_STATE = {
	picking = 2,
	inactive = 1
}
FenceSignIn.BattleNetSignInState = {
	signedIn = 2,
	error = 3,
	idle = 0,
	signingIn = 1
}
FenceSignIn.init = function ( f14_arg0 )
	LUI.Fence.init( f14_arg0 )
	f14_arg0._perController = {}
	for f14_local0 = 0, Engine[0xB686A0A723E6442]() - 1, 1 do
		f14_arg0._perController[f14_local0] = {
			accountPickerState = FenceSignIn.ACCOUNT_PICKER_STATE.inactive
		}
	end
end

FenceSignIn.Start = function ( f13_arg0 )
	DebugPrint( "FenceSignIn.Start" )
end

FenceSignIn.Stop = function ( f12_arg0 )
	DebugPrint( "FenceSignIn.Stop" )
end

FenceSignIn.PostFail = function ( f11_arg0 )
	if f11_arg0._state == LUI.Fence.STATE.fail and Fences[0x279B99DD432C880]() then
		LUI.FlowManager.RequestPopupMenu( nil, "SigninErrorPopup", false, nil, false, {}, nil, false, true )
	end
end

function PopupSignInQueue( f9_arg0, f9_arg1 )
	assert( f9_arg1 )
	local f9_local0 = {
		message = Engine[0xED84C33EC5F01EA]( "LUA_MENU_MP/SERVER_QUEUE" ),
		description = Engine[0xED84C33EC5F01EA]( "PLATFORM/BNET_SERVER_QUEUE_MSG" )
	}
	local f9_local1 = {}
	local f9_local2 = Engine[0xED84C33EC5F01EA]
	local f9_local3
	if Engine[0x575E9C5B9AAB6F4]() then
		f9_local3 = "LUA_MENU/QUIT_DESKTOP"
	else
		f9_local3 = "MENU/EXIT"
	end
	f9_local1.label = f9_local2( f9_local3 )
	f9_local1.alignment = LUI.Alignment.Center
	f9_local1.action = function ()
		if Engine[0x575E9C5B9AAB6F4]() then
			Engine[0xDEE6107B26F8BB6]()
		else
			LUI.FlowManager.RequestLeaveMenu()
		end
	end
	
	f9_local0.buttons = f9_local1
	f9_local1 = f9_arg1.controllerIndex
	if not f9_local1 then
		f9_local1 = Engine[0x45B054C920178E9]()
	end
	f9_local0.controllerIndex = f9_local1
	f9_local1 = MenuBuilder.BuildRegisteredType( "FenceSigninQueueDialogPopup", f9_local0 )
	f9_local1.id = "SigninQueuePopup"
	return f9_local1
end

FenceSignIn.OpenSignInQueuedPopup = function ( f7_arg0 )
	local f7_local0 = f7_arg0
	LUI.FlowManager.RequestPopupMenu( nil, "SigninQueuePopup", false, nil, false, {
		onCancel = function ( f8_arg0, f8_arg1 )
			f7_arg0._perController[f8_arg1].isCancelling = true
		end
	}, nil, true, true )
	f7_arg0._openedWaitPopup = "SigninQueuePopup"
end

FenceSignIn.UpdateState = function ( f5_arg0 )
	assert( f5_arg0._state ~= LUI.Fence.STATE.fail )
	f5_arg0._state = LUI.Fence.STATE.pass
	if Engine[0x21103F2ABD5B496]() then
		f5_arg0._state = LUI.Fence.STATE.pass
	end
	if Engine[0x5575DCFF312365A]() then
		local f5_local0 = 0
		if not Engine[0xD2813B521711C11]( f5_local0 ) then
			local f5_local1 = Engine[0x170DF85DCE182E7]()
			local f5_local2 = function ( f6_arg0 )
				if f5_arg0._openedWaitPopup ~= nil and f5_arg0._openedWaitPopup ~= f6_arg0 then
					LUI.FlowManager.RequestLeaveMenuByName( f5_arg0._openedWaitPopup, true )
					f5_arg0._openedWaitPopup = nil
					return true
				elseif f5_arg0._openedWaitPopup == nil then
					return true
				else
					return false
				end
			end
			
			if f5_local1 then
				if f5_local2( "SigninQueuePopup" ) then
					f5_arg0:OpenSignInQueuedPopup()
				end
			elseif f5_arg0._openedWaitPopup then
				LUI.FlowManager.RequestLeaveMenuByName( f5_arg0._openedWaitPopup, true )
				f5_arg0._openedWaitPopup = nil
			end
			local f5_local3 = Engine[0x2D5DC5650ED3A1E]( f5_local0 )
			if f5_local3 == FenceSignIn.BattleNetSignInState.error then
				f5_arg0._state = LUI.Fence.STATE.fail
			elseif f5_local3 ~= FenceSignIn.BattleNetSignInState.signedIn then
				f5_arg0._state = LUI.Fence.STATE.block
			end
		elseif f5_arg0._openedWaitPopup then
			LUI.FlowManager.RequestLeaveMenuByName( f5_arg0._openedWaitPopup, true )
			f5_arg0._openedWaitPopup = nil
		end
		return 
	elseif Engine[0xE457944EE65BCA1]() then
		f5_arg0._state = LUI.Fence.STATE.block
		return 
	end
	for f5_local4 = 0, Engine[0xB686A0A723E6442]() - 1, 1 do
		if Engine[0x10A5732AB1DAE9F]( f5_local4 ) and not Engine[0xD2813B521711C11]( f5_local4 ) then
			assert( Engine[0x9D348E40740E9A8]() )
			if f5_arg0._perController[f5_local4].accountPickerState == FenceSignIn.ACCOUNT_PICKER_STATE.inactive then
				f5_arg0._state = LUI.Fence.STATE.block
				f5_arg0._perController[f5_local4].accountPickerState = FenceSignIn.ACCOUNT_PICKER_STATE.picking
				Engine[0x4DECC2B7654EAB1]( f5_local4, false )
				return 
			end
		end
	end
	local f5_local4 = 0
	local f5_local1 = 0
	for f5_local2 = 0, Engine[0xB686A0A723E6442]() - 1, 1 do
		if Engine[0x10A5732AB1DAE9F]( f5_local2 ) and Engine[0xD2813B521711C11]( f5_local2 ) then
			f5_local4 = f5_local4 + 1
			if not Engine[0x757E77CA15D6B8F]( f5_local2 ) then
				f5_local1 = f5_local1 + 1
			end
		end
	end
	local f5_local2 = false
	if Dvar[0x9E5BE3B4BBA4E0E]( "#x3297ffeae3a9e9231" ) and Engine[0x836C8AD984F14F6]() and 0 < f5_local4 then
		f5_local2 = true
	end
	if 0 < f5_local4 and 0 < f5_local1 then
		f5_local2 = true
	end
	if f5_local2 then
		for f5_local3 = 0, Engine[0xB686A0A723E6442]() - 1, 1 do
			if Engine[0x10A5732AB1DAE9F]( f5_local3 ) and not Engine[0xD2813B521711C11]( f5_local3 ) then
				Engine[0x54DE5FB69D3BA90]( f5_local3 )
				f5_arg0._perController[f5_local3].accountPickerState = FenceSignIn.ACCOUNT_PICKER_STATE.inactive
			end
		end
	else
		f5_arg0._state = LUI.Fence.STATE.fail
	end
end

function PopupSignInError( f1_arg0, f1_arg1 )
	local f1_local0 = "LUA_MENU/PROFILE_NOT_SIGNED_IN"
	if Engine[0x836C8AD984F14F6]() then
		f1_local0 = "PLATFORM/NOT_SIGNED_IN"
	end
	if Engine[0x9258F49F515F97B]() then
		f1_local0 = "XBOXLIVE/MUSTLOGIN"
	end
	local f1_local1 = {}
	local f1_local2 = f1_arg1.controllerIndex
	if not f1_local2 then
		f1_local2 = Engine[0x45B054C920178E9]()
	end
	f1_local1.controllerIndex = f1_local2
	f1_local1.title = Engine[0xED84C33EC5F01EA]( "MENU/SIGN_IN" )
	f1_local1.message = Engine[0xED84C33EC5F01EA]( f1_local0 )
	f1_local1.buttons = {
		{
			label = Engine[0xED84C33EC5F01EA]( "MENU/OK" )
		}
	}
	if Engine[0x5575DCFF312365A]() then
		f1_local1.message = Engine[0xAF7EC673FFF4FE4]()
		f1_local1.buttons[1].label = Engine[0xED84C33EC5F01EA]( "LUA_MENU/QUIT_DESKTOP" )
		f1_local1.buttons[1].action = function ()
			Engine[0xDEE6107B26F8BB6]()
		end
		
		if Engine[0x6983E9F2847EAED]() then
			table.insert( f1_local1.buttons, {
				label = Engine[0xED84C33EC5F01EA]( "LUA_MENU/RESTART" ),
				action = function ( f3_arg0, f3_arg1 )
					Engine[0x34C623E28A1C5E7]( "" )
				end
			} )
		end
		if Engine[0xD87B38D9E227ECC]() then
			f1_local1.title = Engine[0xED84C33EC5F01EA]( "EXE/SERVER_DISCONNECTED" )
		end
	end
	f1_local2 = MenuBuilder.BuildRegisteredType( "GenericImagePopup", f1_local1 )
	f1_local2.id = "SigninErrorPopup"
	f1_local2:registerEventHandler( "not_below_blocking_fence", function ( element, event )
		if Engine[0x9D348E40740E9A8]() then
			Engine[0xE49CE4BCE0701D5]( "Sign in fence failed" )
			Dvar[0x8EA06EEDB58D872]( "#x3a19e842a39482ea0", false )
		end
	end )
	return f1_local2
end

MenuBuilder.registerType( "SigninQueuePopup", PopupSignInQueue )
MenuBuilder.registerType( "SigninErrorPopup", PopupSignInError )
LUI.Fence.Register( "signIn", FenceSignIn )
LockTable( _M )
