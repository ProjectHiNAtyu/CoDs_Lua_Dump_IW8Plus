-- Generated by CoDLuaDecompiler
-- Version: 2.4.2
-- Date: 21-11-2025 08:48
module( ..., package.seeall )
local f0_local0 = function ( f22_arg0, f22_arg1, f22_arg2, f22_arg3 )
	local f22_local0 = LUI.DeepCopy( f22_arg0._weaponTable )
	if f22_arg2 then
		f22_local0.attachments[f22_arg2].ref = ATTACHMENT.none
		f22_local0.attachments[f22_arg2].variantID = ATTACHMENT.baseVariant
	end
	if not f22_arg1 then
		f22_arg1 = #f22_local0.attachments + 1
	end
	if f22_arg3 then
		f22_local0.attachments[f22_arg1] = f22_local0.attachments[f22_arg1] or {}
		f22_local0.attachments[f22_arg1].ref = f22_arg0._attachRef
		f22_local0.attachments[f22_arg1].variantID = f22_arg3
	end
	return f22_local0
end

local f0_local1 = function ( f21_arg0, f21_arg1, f21_arg2, f21_arg3 )
	if not Engine[0x12586A3F4FB490E]() or not f21_arg0._weaponModel then
		return 
	else
		WEAPON.LoadAndSetModel( f21_arg1, f21_arg0._weaponModel, f21_arg0._currentTable, {
			forceOffsetsAndRotations = true
		} )
	end
end

local f0_local2 = function ( f20_arg0, f20_arg1, f20_arg2, f20_arg3 )
	local f20_local0 = Reticle[0x15C60EB1A12545F]( f20_arg1, WEAPON.GetWeaponModelName( f20_arg2.weapon, f20_arg2, {
		includeAttachments = true
	} ), false )
	if not String.IsNilOrEmpty( f20_local0 ) and f20_arg3.menuName == "AttachmentAppearanceSelect" and f20_arg0._category == ATTACHMENT.opticCategory and f20_arg0.ReticlePreview then
		ACTIONS.AnimateSequence( f20_arg0, "ShowReticle" )
		f20_arg0.ReticlePreview:SetPreviewImage( f20_local0 )
	else
		ACTIONS.AnimateSequence( f20_arg0, "HideReticle" )
	end
end

local f0_local3 = function ( f18_arg0, f18_arg1, f18_arg2 )
	return function ()
		FrontEndScene.SetExclusiveWeaponModels( {
			FrontEndScene.ClientWeapons.Preview
		} )
		f18_arg0._weaponModel = WEAPON.GetWeaponModel( f18_arg0, FrontEndScene.ClientWeapons.Preview, CSV.weaponOffsets.attachmentFile )
		f18_arg0:addElement( f18_arg0._weaponModel )
		f18_arg0( f18_arg0, f18_arg0, f18_arg0, f18_arg0._currentVariantID )
	end
	
end

local f0_local4 = function ( f5_arg0, f5_arg1, f5_arg2 )
	assert( f5_arg0.Attachments )
	assert( f5_arg0.MenuTitle )
	if Engine[0x2DA54CF5D6B7F02]() then
		if not f5_arg2.weaponSlot then
			DebugPrint( "WARNING: Missing \"weaponSlot\" option for AttachmentAppearanceSelectBase menu. Only OK after a MyChanges." )
			f5_arg2.weaponSlot = 0
		end
		if not f5_arg2.loadoutIndex then
			DebugPrint( "WARNING: Missing \"loadoutIndex\" option for AttachmentAppearanceSelectBase menu. Only OK after a MyChanges." )
			f5_arg2.loadoutIndex = 0
		end
		if not f5_arg2.variantData then
			DebugPrint( "WARNING: Missing \"variantData\" option for AttachmentAppearanceSelectBase menu. Only OK after a MyChanges." )
			f5_arg2.variantData = {}
		end
		if not f5_arg2.attachmentRef then
			DebugPrint( "WARNING: Missing \"attachment\" option for AttachmentAppearanceSelectBase menu. Only OK after a MyChanges." )
			f5_arg2.attachmentRef = "acog"
		end
	end
	if f5_arg0.ItemDetails then
		f5_arg0.ItemDetails:SetupForAttachmentSkins()
	end
	if 1 < #f5_arg2.variantData then
		table.sort( f5_arg2.variantData, function ( f17_arg0, f17_arg1 )
			if not f17_arg0 then
				return false
			elseif not f17_arg1 then
				return true
			else
				return f17_arg0.variantID < f17_arg1.variantID
			end
		end )
	end
	local f5_local0 = LOADOUT.GetFrontendLoadoutWithShowcase( f5_arg1, f5_arg2.loadoutIndex, f5_arg2.forShowcase )
	local f5_local1 = f5_local0.weaponSetups[f5_arg2.weaponSlot]
	f5_arg0._weaponTable = WEAPON.GenerateWeaponTable( f5_local1 )
	if f5_arg0.DetailedEquippedSlots then
		f5_arg0.DetailedEquippedSlots:Setup( f5_arg0._weaponTable, f5_arg2.category )
		local f5_local2 = 0
		for f5_local6, f5_local7 in ddlpairs( f5_local1.attachmentSetup ) do
			if ATTACHMENT.GetRefFromSetup( f5_local7 ) ~= ATTACHMENT.none then
				f5_local2 = f5_local2 + 1
			end
		end
		f5_arg0.DetailedEquippedSlots.EquippedText:setText( Engine[0xED84C33EC5F01EA]( 0x1E1C8D199A4092D, f5_local2, WEAPON.maxAttachmentsPerWeapon ) )
	end
	f5_arg0._attachRef = f5_arg2.attachmentRef
	local f5_local2 = f5_arg2.attachmentRef
	f5_arg0.MenuTitle:SetTitle( Engine[0xED84C33EC5F01EA]( 0x1580DB40A0528B1 ) )
	local f5_local3, f5_local4 = nil
	if f5_arg2.attachSlot then
		f5_local3 = f5_local1.attachmentSetup[f5_arg2.attachSlot - 1].variantID:get()
		f5_local4 = ATTACHMENT.GetRefFromSetup( f5_local1.attachmentSetup[f5_arg2.attachSlot - 1] )
	end
	f5_arg0._equippedAttach = f5_local4
	f5_arg0._attachmentData = f5_arg2.attachmentData
	f5_arg0._category = f5_arg2.category
	local f5_local5 = f5_local4 == f5_arg0._attachRef
	local f5_local6 = 0
	if f5_arg0.AttachmentAppearanceDetails and f5_local3 and f5_local5 then
		for f5_local16, f5_local17 in ipairs( f5_arg2.variantData ) do
			if f5_local3 == f5_local17.variantID then
				f5_local6 = f5_local16
				local f5_local10 = ATTACHMENT.GetName( f5_local2, f5_arg0._weaponTable.weapon )
				local f5_local11 = f5_arg0.AttachmentAppearanceDetails
				local f5_local12 = f5_local11
				f5_local11 = f5_local11.Setup
				local f5_local13 = f5_local17
				local f5_local14 = f5_arg0._weaponTable
				local f5_local15
				if f5_local5 then
					f5_local15 = f5_local5
				else
					f5_local15 = f5_local3
				end
				f5_local11( f5_local12, f5_local13, f5_local14, f5_local15, f5_arg2.blockedCategorySlot, f5_local10 )
			end
		end
	end
	f5_arg0.Attachments:SetNumChildren( 0 )
	f5_arg0.Attachments:SetRefreshChild( function ( f16_arg0, f16_arg1, f16_arg2 )
		local f16_local0 = f5_arg0.variantData[f5_arg0.Attachments:GetContentIndex( f16_arg1, f16_arg2 ) + 1]
		local f16_local1
		if f5_arg0 == f16_local0.variantID then
			f16_local1 = f5_arg0
		else
			f16_local1 = false
		end
		f16_arg0:Setup( f16_local0, f16_local1, f5_arg0.weapon:get() )
		local f16_local2 = ATTACHMENT.GetLootIDForVariant( f5_arg0._weaponTable.weapon, f16_local0.ref, f16_local0.variantID )
		local f16_local3 = f16_local0.variantID
		local f16_local4 = WEAPON.baseVariant
		f16_arg0:SetDisabled( not (REG14 and LOOT.IsUnlockedWithID( f5_arg0, f16_local2 ) or PROGRESSION.IsUnlocked( f5_arg0, LOOT.itemTypes.WEAPON, f16_local0.ref )) )
	end )
	f5_arg0.Attachments:SetNumChildren( #f5_arg2.variantData )
	f5_arg0.Attachments:SetDefaultFocus( f5_arg0.Attachments:GetPositionForIndex( f5_local6, {
		relativePosition = false
	} ) )
	f5_arg0.Attachments:RefreshContent()
	for f5_local7 = 1, #f5_arg2.variantData, 1 do
		FrontEndScene.RequestWeaponViewModels( {
			WEAPON.GetWeaponModelName( f5_arg0._weaponTable.weapon, f0_local0( f5_arg0, f5_arg2.attachSlot, f5_arg2.blockedCategorySlot, f5_arg2.variantData[f5_local7].variantID ), {
				includeCamos = true,
				includeAttachments = true,
				includeStickers = true,
				controllerIndex = f5_arg1
			} )
		}, f5_arg1 )
	end
	local f5_local7 = ATTACHMENT.GetName( f5_local2, f5_arg0._weaponTable.weapon )
	f5_arg0:registerEventHandler( "update_showcase", function ( element, event )
		if element.AttachmentAppearanceDetails then
			element.AttachmentAppearanceDetails:Setup( event.variantData, element._weaponTable, f5_arg0 and f5_arg0, f5_arg0.blockedCategorySlot, f5_arg0 )
		elseif element.ItemDetails then
			local f15_local0 = 0x23ABF974ED0021F
			if event.variantData.variantID ~= ATTACHMENT.baseVariant then
				f15_local0 = event.variantData.name
			end
			local f15_local1 = {
				name = f15_local0,
				localizedDesc = f5_arg0,
				weaponTable = element._weaponTable,
				tacticalBuildData = event.tacticalBuildData,
				variantData = event.variantData
			}
			if not String.IsNilOrEmpty( event.variantData.desc ) then
				f15_local1.localizedDesc = f15_local1.localizedDesc .. "\n" .. Engine[0xED84C33EC5F01EA]( event.variantData.desc )
			end
			element.ItemDetails:UpdateDetails( f15_local1 )
		end
		element._currentVariantID = event.variantData.variantID
		local f15_local0 = LUI.FlowManager.GetScopedData( LOADOUT.GetGunsmithTabsMenuRef() )
		element._currentTable = ATTACHMENT.GetTableWithAttachmentEquipped( f5_arg0, element._weaponTable, element._equippedAttach, element._attachRef, element._category, element._currentVariantID, f5_arg0.attachSlot, element._attachmentData, f15_local0.attachmentData[GL_HACK.GetWeaponMPRef( element._weaponTable.weapon )].attachments )
		f5_arg0( element, f5_arg0, element._attachRef, event.variantData.variantID )
		f5_arg0( element, f5_arg0, element._currentTable, f5_arg0 )
	end )
	local f5_local8 = function ( f14_arg0, f14_arg1 )
		if f14_arg1 and f14_arg1.blockedEquippedAttachments then
			for f14_local0 = 1, #f14_arg1.blockedEquippedAttachments, 1 do
				GUNSMITH.EquipAttachment( f5_arg0, f5_arg0, ATTACHMENT.none, f5_arg0, {
					isNewAttachment = true,
					attachSlot = GUNSMITH.GetSelectedAttachIndexForCategory( f14_arg1.blockedEquippedAttachments[f14_local0].category, f14_arg0._weaponTable )
				} )
			end
		end
		local f14_local0 = GUNSMITH.EquipAttachment
		local f14_local2 = f14_arg0
		local f14_local3 = f5_arg0
		local f14_local4 = f5_arg0._attachRef
		local f14_local5 = f5_arg0
		local f14_local6 = {
			menusToLeave = {
				nil,
				nil,
				"AttachmentAppearanceSelect",
				[1] = LOADOUT.GetAttachmentSelectMenuRef()
			},
			attachSlot = f5_arg0.attachSlot,
			lootID = f14_arg1.variantData.lootID,
			variantID = f14_arg1.variantData.variantID
		}
		local f14_local7
		if f14_arg1.variantData.variantID == f5_arg0 then
			f14_local7 = not f5_arg0
		else
			f14_local7 = true
		end
		f14_local6.isNewVariantID = f14_local7
		f14_local0( f14_local2, f14_local3, f14_local4, f14_local5, f14_local6 )
		if f14_arg1 and f14_arg1.attachmentsToEquip then
			for f14_local3, f14_local4 in ipairs( f14_arg1.attachmentsToEquip ) do
				GUNSMITH.EquipAttachment( f14_arg0, f5_arg0, f14_local4.ref, f5_arg0, {
					attachSlot = GUNSMITH.GetSelectedAttachIndexForCategory( f14_local4.category, f14_arg0._weaponTable ),
					survivalCost = f14_local4.survivalCost
				} )
			end
		end
	end
	
	local f5_local9 = function ( f12_arg0, f12_arg1 )
		local f12_local0 = f12_arg0._equippedAttach
		local f12_local1
		if f12_arg1 then
			f12_local1 = f12_arg1
		else
			f12_local1 = f12_arg1.variantData
			if f12_local1 then
				f12_local1 = f12_arg1.variantData.ref
			end
		end
		f12_local0 = f12_local0 ~= f12_local1
		f12_local1 = f5_arg0
		local f12_local2
		if f12_arg1 then
			f12_local2 = f12_arg1
		else
			f12_local2 = f12_arg1.variantData
			if f12_local2 then
				f12_local2 = f12_arg1.variantData.variantID
			end
		end
		if (f12_local0 or f12_local1 ~= f12_local2) and GUNSMITH.IsWeaponSetupBlueprintIntact( f5_arg0 ) then
			GUNSMITH.SetupCallbackFuncForBlueprintEdit( f5_arg0, f5_arg0, GUNSMITH.BlueprintEditStatus.EditBlueprint, function ()
				f12_arg0( f12_arg0, f12_arg0 )
			end )
		else
			f5_arg0( f12_arg0, f12_arg1 )
		end
	end
	
	local f5_local16 = function ( f11_arg0, f11_arg1, f11_arg2, f11_arg3, f11_arg4 )
		local f11_local0 = LUI.FlowManager.GetScopedData( LOADOUT.GetGunsmithTabsMenuRef() )
		local f11_local1 = f11_local0.attachmentData[GL_HACK.GetWeaponMPRef( f11_arg3.weapon )].attachments
		local f11_local2 = f11_arg1.ref == f11_arg2
		local f11_local3 = ATTACHMENT.baseVariant
		if f11_local2 then
			local f11_local4 = f11_arg3.attachments[f11_arg4]
			if f11_local4 then
				f11_local4 = f11_arg3.attachments[f11_arg4].variantID
			end
			f11_local3 = f11_local4
		end
		local f11_local4 = ATTACHMENT.GetTableWithCurrentAttachment( f11_arg3, f11_arg4, f11_arg1.blockedCategorySlot, f11_arg1.ref, f11_local3 )
		local f11_local5 = {}
		local f11_local6, f11_local7, f11_local8 = GUNSMITH.CheckBlockedEquippedAttachmentLogic( f11_arg0, f11_arg3, f11_arg2, f11_local4, f11_arg1.ref, f11_arg1.category, f11_arg1, f11_local1 )
		if f11_local6 and 0 < #f11_local6 then
			f11_local5.blockedEquippedAttachments = f11_local6
			f11_local5.attachmentsToEquip = f11_local7
			f11_local5.substituteSiblingAttachmentsToEquip = f11_local8
		end
		return f11_local5
	end
	
	local f5_local17 = function ( f9_arg0, f9_arg1 )
		local f9_local0 = false
		local f9_local1 = f5_arg0( f5_arg0, f9_arg0._attachmentData, f9_arg0._equippedAttach, f9_arg0._weaponTable, ATTACHMENT.GetAttachSlot( f5_arg0 ) )
		if not Table.IsEmpty( f9_local1 ) and 0 < #f9_local1.blockedEquippedAttachments then
			f9_arg1.blockedEquippedAttachments = f9_local1.blockedEquippedAttachments
			f9_arg1.attachmentsToEquip = f9_local1.attachmentsToEquip
			f9_arg1.substituteSiblingAttachmentsToEquip = f9_local1.substituteSiblingAttachmentsToEquip
			f9_local0 = true
		end
		if f9_local0 then
			LUI.FlowManager.RequestPopupMenu( nil, "PopupYesNo", false, nil, false, {
				title = Engine[0xED84C33EC5F01EA]( 0xF22B2F336C8A05C ),
				message = ATTACHMENT.AddListToBlockedMessage( Engine[0xED84C33EC5F01EA]( 0xA6B88FD8F6E0ED1, #f9_arg1.blockedEquippedAttachments, ATTACHMENT.GetName( f9_arg0._attachRef ) ), f9_arg1.blockedEquippedAttachments ),
				yesLabel = Engine[0xED84C33EC5F01EA]( 0xCA07A93FADF9E95 ),
				noLabel = Engine[0xED84C33EC5F01EA]( 0xDF4B921D6190715 ),
				yesAction = function ( f10_arg0, f10_arg1 )
					f9_arg0( f9_arg0, f9_arg0 )
				end
			}, nil, false, true )
		else
			f5_arg0( f9_arg0, f9_arg1 )
		end
	end
	
	f5_arg0:registerEventHandler( "equip_attachment", function ( element, event )
		f5_arg0( element, event )
		return true
	end )
	if Engine[0x12586A3F4FB490E]() then
		MenuUtils.SetupSceneChangeCallback( f5_arg0, f0_local0( f5_arg0, f5_arg1 ) )
		f5_arg0._currentTable = f0_local0( f5_arg0, f5_arg2.attachSlot )
		if CONDITIONS.IsWeaponPreviewEnabled() and not CONDITIONS.IsMobileOrMobileSim() then
			f5_arg0.HelperBar.ButtonHelperText:PushButtonPrompt( {
				side = "left",
				priority = 10,
				button_ref = "button_r3",
				helper_text = Engine[0xED84C33EC5F01EA]( 0xCBEAF62674E5E75 ),
				helper_definition = Engine[0xED84C33EC5F01EA]( 0xF2D581450245105 )
			} )
			f5_arg0:AddGamepadEventCallback( "button_right_stick", function ( f7_arg0, f7_arg1 )
				f5_arg0.weaponTable = f7_arg0._currentTable
				LUI.FlowManager.RequestAddMenu( "WeaponPreview", true, f7_arg1.controller or f5_arg0, false, f5_arg0, true )
			end )
		end
	end
	f5_arg0:addEventHandler( "menu_create", function ( f6_arg0, f6_arg1 )
		f6_arg0.Attachments:processEvent( {
			name = "gain_focus",
			controller = f6_arg1.controller
		} )
	end )
	f5_arg0.Attachments:TouchMouseSetActiveToDefaultFocusMenuCreate( f5_arg1 )
end

local f0_local5 = function ( f4_arg0, f4_arg1, f4_arg2 )
	f4_arg0.PostLoadShared = f0_local0
end

function AttachmentAppearanceSelectBase( menu, controller )
	local self = LUI.UIElement.new()
	self.id = "AttachmentAppearanceSelectBase"
	local f1_local1
	if controller then
		f1_local1 = controller
	else
		f1_local1 = controller.controllerIndex
	end
	f1_local1 = LUI.ValidateControllerIndex( self, f1_local1 )
	local f1_local2 = self
	self.addButtonHelperFunction = function ( f3_arg0, f3_arg1 )
		f3_arg0:AddButtonHelperText( {
			side = "left",
			button_ref = "button_primary",
			priority = 2,
			helper_text = Engine[0xED84C33EC5F01EA]( 0x1A9362F611D2930 )
		} )
	end
	
	self:addEventHandler( "menu_create", self.addButtonHelperFunction )
	self:AddGamepadEventCallback( "button_secondary", function ( f2_arg0, f2_arg1 )
		local f2_local0 = f2_arg1.controller or menu
		if not CONDITIONS.IsMobileOrMobileSim() then
			ACTIONS.LeaveMenu( menu )
		end
	end )
	f0_local0( self, f1_local1, controller )
	return self
end

MenuBuilder.registerType( "AttachmentAppearanceSelectBase", AttachmentAppearanceSelectBase )
LockTable( _M )
