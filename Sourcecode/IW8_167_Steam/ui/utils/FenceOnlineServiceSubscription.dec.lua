-- Generated by CoDLuaDecompiler
-- Version: 2.4.2
-- Date: 17-11-2025 01:22
module( ..., package.seeall )
FenceOnlineServiceSubscription = LUI.Class( LUI.Fence )
FenceOnlineServiceSubscription.UPSELL_STATE = {
	done = 3,
	selling = 2,
	inactive = 1
}
FenceOnlineServiceSubscription.init = function ( f12_arg0 )
	LUI.Fence.init( f12_arg0 )
	f12_arg0._perController = {}
	for f12_local0 = 0, Engine.DCJGJDDEHE() - 1, 1 do
		f12_arg0._perController[f12_local0] = {
			onlineUpsell = FenceOnlineServiceSubscription.UPSELL_STATE.inactive
		}
	end
	f12_arg0._isShowingBlockingPopup = false
end

FenceOnlineServiceSubscription.Start = function ( f11_arg0 )
	DebugPrint( "FenceOnlineServiceSubscription.Start" )
	if f11_arg0._isShowingBlockingPopup then
		LUI.FlowManager.RequestLeaveMenuByName( "popup_waiting_for_online_subscription_info", true )
		f11_arg0._isShowingBlockingPopup = false
	end
	f11_arg0._hasOnlineServiceSub = {}
	for f11_local0 = 0, Engine.DCJGJDDEHE() - 1, 1 do
		if Engine.BBHAECABBD( f11_local0 ) and Engine.BHCCFDDEHE( f11_local0 ) then
			f11_arg0._hasOnlineServiceSub[f11_local0] = Engine.CGJEJFBEAG( f11_local0 )
		end
	end
end

FenceOnlineServiceSubscription.Stop = function ( f10_arg0 )
	DebugPrint( "FenceOnlineServiceSubscription.Stop" )
	if f10_arg0._isShowingBlockingPopup then
		LUI.FlowManager.RequestLeaveMenuByName( "popup_waiting_for_online_subscription_info", true )
		f10_arg0._isShowingBlockingPopup = false
	end
end

FenceOnlineServiceSubscription.PostFail = function ( f9_arg0 )
	if f9_arg0._state == LUI.Fence.STATE.fail then
		local f9_local0 = Engine.IJEBHJIJF()
		LUI.FlowManager.RequestPopupMenu( nil, "PopupNoOnlineServiceSubscriptionError", false, f9_local0, false, {
			controllerIndex = f9_local0
		}, nil, false, true )
	end
end

FenceOnlineServiceSubscription.OnBackOut = function ( f8_arg0 )
	DebugPrint( "FenceOnlineServiceSubscription.OnBackOut" )
	Engine.EBIDFIDHIE( "xcancelinvitejoin", Engine.IJEBHJIJF() )
	if Engine.DAFGFCFHJI and not Lobby.DFFFFJHCEH() then
		Engine.DAGFFDGFII( "xstopparty" )
	end
	if Lobby.GFFECBCCF() and not Lobby.BGIADHIHAG() then
		Engine.DAGFFDGFII( "xstopprivateparty" )
		Engine.DAGFFDGFII( "xstartprivateparty" )
	end
end

FenceOnlineServiceSubscription.UpdateState = function ( f7_arg0 )
	assert( f7_arg0._state ~= LUI.Fence.STATE.fail )
	f7_arg0._state = LUI.Fence.STATE.pass
	for f7_local0 = 0, Engine.DCJGJDDEHE() - 1, 1 do
		if Engine.BBHAECABBD( f7_local0 ) then
			if Engine.BHCCFDDEHE( f7_local0 ) then
				if not f7_arg0._hasOnlineServiceSub[f7_local0] then
					if f7_arg0._perController[f7_local0].onlineUpsell == FenceOnlineServiceSubscription.UPSELL_STATE.inactive then
						f7_arg0._perController[f7_local0].onlineUpsell = FenceOnlineServiceSubscription.UPSELL_STATE.selling
						f7_arg0._state = LUI.Fence.STATE.block
						Engine.DBHBIHJDEC( f7_local0 )
						break
					end
					local f7_local3 = f7_arg0._perController[f7_local0].onlineUpsell == FenceOnlineServiceSubscription.UPSELL_STATE.selling
					if Engine.EBCDFHECAC() then
						f7_arg0._state = LUI.Fence.STATE.block
						break
					elseif f7_local3 then
						f7_arg0._perController[f7_local0].onlineUpsell = FenceOnlineServiceSubscription.UPSELL_STATE.done
						f7_arg0._state = LUI.Fence.STATE.fail
					end
				end
				f7_arg0._perController[f7_local0].onlineUpsell = FenceOnlineServiceSubscription.UPSELL_STATE.inactive
			end
			f7_arg0._state = LUI.Fence.STATE.block
			if not f7_arg0._isShowingBlockingPopup then
				f7_arg0:OpenPopupWaitingForOnlineSubsciptionInfo()
			end
		end
		f7_arg0._perController[f7_local0].onlineUpsell = FenceOnlineServiceSubscription.UPSELL_STATE.inactive
	end
end

function GetErrorMessageButtons( f4_arg0 )
	return {
		{
			label = Engine.CBBHFCGDIC( "MENU/OK" ),
			action = function ( f6_arg0, f6_arg1 )
				LUI.FlowManager.RequestLeaveMenu( f6_arg0:GetCurrentMenu(), true )
			end
			
		},
		{
			label = Engine.CBBHFCGDIC( "MENU/GO_OFFLINE" ),
			action = function ( f5_arg0, f5_arg1 )
				Dvar.DHEGHJJJHI( "splitscreen", false )
				Engine.CDGCBCBAJ( "Going Offline", f4_arg0 )
				Engine.DAGFFDGFII( "xstopprivateparty" )
				Engine.DAGFFDGFII( "xstartprivateparty" )
				LUI.FlowManager.RequestLeaveMenu( f5_arg0:GetCurrentMenu(), true )
				LUI.FlowManager.RequestAddMenu( "MainMenuOffline", false, f4_arg0 )
			end
			
		}
	}
end

function PopupNoOnlineServiceSubscriptionError( f3_arg0, f3_arg1 )
	assert( f3_arg1 )
	local f3_local0 = nil
	if Engine.CIEGIACHAE() then
		f3_local0 = "PLATFORM/PSPLUS_REQUIRED"
	else
		f3_local0 = "XBOXLIVE/MPNOTALLOWED"
	end
	assert( f3_local0 )
	local f3_local1 = {
		controllerIndex = f3_arg1.controllerIndex,
		title = Engine.CBBHFCGDIC( "MENU/CONNECTION_FAILED" ),
		message = Engine.CBBHFCGDIC( f3_local0 )
	}
	local f3_local2 = not Engine.BFDACIJIAD( f3_arg1.controllerIndex )
	if f3_local2 then
		f3_local1.message = Engine.CBBHFCGDIC( "LUA_MENU/N_NEWLINE_M", Engine.JCBDICCAH( Engine.DHCFHGIABE( f3_arg1.controllerIndex ) ), f3_local1.message )
	end
	if f3_local2 then
		f3_local1.buttons = BOOT.GetOkayPopupButtons()
	else
		f3_local1.buttons = GetErrorMessageButtons( f3_arg1.controllerIndex )
	end
	local f3_local3 = MenuBuilder.BuildRegisteredType( "GenericImagePopup", f3_local1 )
	f3_local3.id = "PopupNoOnlineServiceSubscriptionError"
	return f3_local3
end

FenceOnlineServiceSubscription.OpenPopupWaitingForOnlineSubsciptionInfo = function ( f2_arg0 )
	LUI.FlowManager.RequestPopupMenu( nil, "popup_waiting_for_online_subscription_info", false, nil, false, args, nil, true, true )
	f2_arg0._isShowingBlockingPopup = true
end

function OpenPopupWaitingForOnlineSubsciptionInfo( f1_arg0, f1_arg1 )
	local f1_local0 = MenuBuilder.BuildRegisteredType( "live_dialog_text_box", {
		message = Engine.CBBHFCGDIC( "MENU/WAITING_FOR_ONLINE_SUBSCRIPTION_INFO" )
	} )
	f1_local0.id = "popup_waiting_for_online_subscription_info"
	return f1_local0
end

MenuBuilder.registerType( "popup_waiting_for_online_subscription_info", OpenPopupWaitingForOnlineSubsciptionInfo )
MenuBuilder.registerType( "PopupNoOnlineServiceSubscriptionError", PopupNoOnlineServiceSubscriptionError )
LUI.Fence.Register( "onlineServiceSubscription", FenceOnlineServiceSubscription )
LockTable( _M )
