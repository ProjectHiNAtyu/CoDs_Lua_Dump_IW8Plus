-- Generated by CoDLuaDecompiler
-- Version: 2.4.2
-- Date: 13-10-2025 14:16
module( ..., package.seeall )
FenceOnlineData = LUI.Class( LUI.Fence )
FenceOnlineData.CODE_STATE = {
	downloading = 2,
	inactive = 0,
	success = 3,
	requested = 1,
	failure = 4
}
FenceOnlineData.CONTROLLER_FENCE_STATE = {
	pass = 2,
	block = 3,
	fail = 4,
	inactive = 1
}
FenceOnlineData.GAMEMODE_TYPE = {
	sp = 1,
	mp = 2,
	cp = 3,
	none = 0
}
FenceOnlineData.CODE_FENCE = {
	[FenceOnlineData.GAMEMODE_TYPE.none] = "MAIN_ONLINE_DATA",
	[FenceOnlineData.GAMEMODE_TYPE.sp] = "SP_ONLINE_DATA",
	[FenceOnlineData.GAMEMODE_TYPE.mp] = "MP_ONLINE_DATA",
	[FenceOnlineData.GAMEMODE_TYPE.cp] = "CP_ONLINE_DATA"
}
FenceOnlineData.init = function ( f22_arg0, f22_arg1 )
	LUI.Fence.init( f22_arg0 )
	f22_arg0._perController = {}
	f22_arg0._gameMode = f22_arg1
	for f22_local0 = 0, Engine[0xB686A0A723E6442]() - 1, 1 do
		Fences[0xA0BBD335F1EECF7]( f22_local0, f22_arg0._gameMode )
		f22_arg0._perController[f22_local0] = {
			isCancelling = false,
			fenceState = FenceOnlineData.CONTROLLER_FENCE_STATE.inactive
		}
	end
end

FenceOnlineData.Start = function ( f21_arg0 )
	DebugPrint( "FenceOnlineData.Start" )
	f21_arg0._isCancelling = false
end

FenceOnlineData.Stop = function ( f20_arg0 )
	DebugPrint( "FenceOnlineData.Stop" )
	LUI.FlowManager.RequestLeaveMenuByName( "popup_getting_data", true )
	f20_arg0._openedWaitPopup = false
end

FenceOnlineData.OpenPopup = function ( f15_arg0, f15_arg1 )
	local f15_local0 = f15_arg0
	local f15_local1 = Engine[0xED84C33EC5F01EA]( 0xF93C5F8D1EF1482 )
	LUI.FlowManager.RequestPopupMenu( nil, "popup_getting_data", false, f15_arg1, false, {
		isNonCriticalPopup = true,
		onCancel = function ( f19_arg0, f19_arg1 )
			DebugPrint( "Cancelling FenceOnlineData" )
			f15_arg0._perController[f19_arg1.controller].isCancelling = true
			f15_arg0._isCancelling = true
		end,
		onStatusUpdateCallback = function ( f18_arg0 )
			if Fences[0x24C28457BE3BBEC]( Enum[0xA0086E2C650E8B7][0xE2075786D66C359] ) then
				return Fences[0x7E779F6CED13F21]( f18_arg0, FenceOnlineData.CODE_FENCE[f15_arg0._gameMode] )
			else
				
			end
		end,
		onMessageUpdateCallback = function ( f17_arg0 )
			local f17_local0 = Fences[0x16D16AAE1F86E41]( f17_arg0, FenceOnlineData.CODE_FENCE[f15_arg0._gameMode] )
			if not f17_local0 then
				f17_local0 = f15_arg0
			end
			return f17_local0
		end,
		onPrintStatusCallback = function ( f16_arg0 )
			Fences[0x661C885A3C824C3]( f16_arg0, FenceOnlineData.CODE_FENCE[f15_arg0._gameMode], "FenceOnlineData" )
		end,
		controllerIndex = f15_arg1
	}, nil, true, true )
	f15_arg0._openedWaitPopup = true
end

FenceOnlineData.OnBackOut = function ( f14_arg0 )
	DebugPrint( "FenceOnlineData.OnBackOut" )
	for f14_local0 = 0, Engine[0xB686A0A723E6442]() - 1, 1 do
		Fences[0xA0BBD335F1EECF7]( f14_local0, f14_arg0._gameMode )
	end
	Engine[0xC12257C7145D04]()
end

FenceOnlineData.PostFail = function ( f13_arg0 )
	if f13_arg0._state == LUI.Fence.STATE.fail then
		local f13_local0 = Engine[0x45B054C920178E9]()
		if CONDITIONS.CanAccessOfflineMenu( f13_local0 ) and Dvar[0x9E5BE3B4BBA4E0E]( 0xF0A42245494828C ) then
			LUI.FlowManager.RequestAddMenu( "MainMenuOffline", true, f13_local0 )
		end
		local f13_local1 = {
			controllerIndex = f13_local0
		}
		if not f13_arg0._isCancelling then
			f13_local1.errorString = FenceOnlineData.GetErrorString( f13_arg0, f13_local0 )
			LUI.FlowManager.RequestPopupMenu( nil, "popup_getting_data_error", false, f13_local0, false, f13_local1, nil, false, false )
		else
			LUI.FlowManager.RequestPopupMenu( nil, "popup_getting_data_cancelled", false, f13_local0, false, f13_local1, nil, false, false )
		end
	end
end

FenceOnlineData.UpdateState = function ( f12_arg0 )
	assert( f12_arg0._state ~= LUI.Fence.STATE.fail )
	for f12_local0 = 0, Engine[0xB686A0A723E6442]() - 1, 1 do
		local f12_local3 = Engine[0x10A5732AB1DAE9F]( f12_local0 )
		local f12_local4
		if f12_local3 then
			f12_local4 = f12_local3
		else
			f12_local4 = Engine[0x757E77CA15D6B8F]( f12_local0 )
		end
		if f12_local3 and not f12_local4 then
			local f12_local5 = Fences[0x7C178836F5014BE]( f12_local0, f12_arg0._gameMode )
			if f12_local5 == FenceOnlineData.CODE_STATE.inactive then
				Fences[0xADF35B2AA317BEC]( f12_local0, f12_arg0._gameMode )
				f12_local5 = Fences[0x7C178836F5014BE]( f12_local0, f12_arg0._gameMode )
			end
			if f12_local5 == FenceOnlineData.CODE_STATE.failure then
				f12_arg0._perController[f12_local0].fenceState = FenceOnlineData.CONTROLLER_FENCE_STATE.fail
			elseif f12_local5 ~= FenceOnlineData.CODE_STATE.success then
				f12_arg0._perController[f12_local0].fenceState = FenceOnlineData.CONTROLLER_FENCE_STATE.block
			else
				f12_arg0._perController[f12_local0].fenceState = FenceOnlineData.CONTROLLER_FENCE_STATE.pass
			end
			if f12_arg0._perController[f12_local0].isCancelling then
				f12_arg0._perController[f12_local0].fenceState = FenceOnlineData.CONTROLLER_FENCE_STATE.fail
			end
		end
		f12_arg0._perController[f12_local0].fenceState = FenceOnlineData.CONTROLLER_FENCE_STATE.inactive
		f12_arg0._perController[f12_local0].isCancelling = false
	end
	local f12_local0 = 0
	local f12_local1 = 0
	local f12_local2 = 0
	local f12_local6 = -1
	for f12_local3 = 0, Engine[0xB686A0A723E6442]() - 1, 1 do
		if f12_arg0._perController[f12_local3].fenceState == FenceOnlineData.CONTROLLER_FENCE_STATE.pass then
			f12_local0 = f12_local0 + 1
		end
		if f12_arg0._perController[f12_local3].fenceState == FenceOnlineData.CONTROLLER_FENCE_STATE.block then
			if f12_local6 == -1 then
				f12_local6 = f12_local3
			end
			f12_local1 = f12_local1 + 1
		end
		if f12_arg0._perController[f12_local3].fenceState == FenceOnlineData.CONTROLLER_FENCE_STATE.fail then
			f12_local2 = f12_local2 + 1
		end
	end
	assert( 0 < f12_local2 + f12_local1 + f12_local0, "No active local clients" )
	local f12_local3 = Engine[0x45B054C920178E9]()
	if 0 < f12_local2 then
		for f12_local4 = 0, Engine[0xB686A0A723E6442]() - 1, 1 do
			if f12_arg0._perController[f12_local4].fenceState == FenceOnlineData.CONTROLLER_FENCE_STATE.fail then
				if 0 < f12_local0 and not Lobby[0xEA249848147F9EA]( f12_local4 ) then
					DebugPrint( "Controller #" .. tostring( f12_local4 ) .. " does not have online data. Making client inactive." )
					Engine[0x54DE5FB69D3BA90]( f12_local4 )
					f12_local3 = f12_local4
					local f12_local8 = true
					if f12_arg0._perController[f12_local4].isCancelling then
						local f12_local9 = false
						for f12_local10 = 0, Engine[0xB686A0A723E6442]() - 1, 1 do
							local f12_local13 = Engine[0x10A5732AB1DAE9F]( f12_local10 )
							local f12_local14
							if f12_local13 then
								f12_local14 = f12_local13
							else
								f12_local14 = Engine[0x757E77CA15D6B8F]( f12_local10 )
							end
							if f12_local13 and not f12_local14 and f12_arg0._perController[f12_local10].fenceState == FenceOnlineData.CONTROLLER_FENCE_STATE.pass then
								f12_local9 = true
								break
							end
						end
						if f12_local9 then
							f12_local8 = false
							DebugPrint( "Splitscreen controller #" .. tostring( f12_local4 ) .. " is cancelling online fence, but another player is active -> just ignore the failed fence for the disconnected splitscreen player." )
						elseif f12_local8 then
							f12_arg0._state = LUI.Fence.STATE.block
							LUI.FlowManager.RequestPopupMenu( nil, "GettingDataErrorPopup", false, f12_local4, false, {
								controllerIndex = f12_local4,
								errorString = FenceOnlineData.GetErrorString( f12_arg0, f12_local4 )
							}, nil, false, true )
						end
					end
					elseif f12_local8 then
						f12_arg0._state = LUI.Fence.STATE.block
						LUI.FlowManager.RequestPopupMenu( nil, "GettingDataErrorPopup", false, f12_local4, false, {
							controllerIndex = f12_local4,
							errorString = FenceOnlineData.GetErrorString( f12_arg0, f12_local4 )
						}, nil, false, true )
				end
				f12_arg0._state = LUI.Fence.STATE.fail
				DebugPrint( "FenceOnlineData FAILED" )
			end
		end
	elseif 0 < f12_local1 then
		if f12_local6 ~= -1 then
			f12_local3 = f12_local6
		end
		f12_arg0._state = LUI.Fence.STATE.block
	elseif 0 < f12_local0 then
		f12_arg0._state = LUI.Fence.STATE.pass
	else
		assert( false, "Unexpected state" )
		f12_arg0._state = LUI.Fence.STATE.block
	end
	if f12_arg0._state == LUI.Fence.STATE.pass and Engine[0xCA085C21FCBD7CA]() then
		InitCPRankedDataSources()
	end
	if f12_arg0._state == LUI.Fence.STATE.block and not f12_arg0._openedWaitPopup then
		f12_arg0:OpenPopup( f12_local3 )
	end
end

FenceOnlineData.GetErrorString = function ( f11_arg0, f11_arg1 )
	local f11_local0 = Fences[0xA7D80C060789546]( f11_arg1, FenceOnlineData.CODE_FENCE[f11_arg0._gameMode] )
	if f11_local0 then
		return Engine[0x7D3158A9539A355]( f11_local0 )
	else
		return Engine[0xED84C33EC5F01EA]( 0xA022675513BEB59 )
	end
end

function PopupGettingData( f10_arg0, f10_arg1 )
	local f10_local0 = assert
	local f10_local1
	if f10_arg1 then
		f10_local1 = f10_arg1
	else
		f10_local1 = f10_arg1.onCancel
	end
	f10_local0( f10_local1 )
	f10_local0 = {
		message = Engine[0xED84C33EC5F01EA]( 0xF93C5F8D1EF1482 ),
		onCancel = f10_arg1.onCancel,
		onStatusUpdateCallback = f10_arg1.onStatusUpdateCallback,
		onMessageUpdateCallback = f10_arg1.onMessageUpdateCallback,
		onPrintStatusCallback = f10_arg1.onPrintStatusCallback,
		controllerIndex = f10_arg1.controllerIndex,
		isNonCriticalPopup = f10_arg1.isNonCriticalPopup
	}
	local f10_local2 = nil
	if Engine[0x575E9C5B9AAB6F4]() then
		f10_local2 = MenuBuilder.BuildRegisteredType( "MainLockoutFence", f10_local0 )
	else
		f10_local2 = MenuBuilder.BuildRegisteredType( "MainLockoutFence", f10_local0 )
	end
	f10_local2.id = "popup_getting_data"
	return f10_local2
end

function PopupGettingDataError( f6_arg0, f6_arg1 )
	local f6_local0 = assert
	local f6_local1
	if f6_arg1 then
		f6_local1 = f6_arg1
	else
		f6_local1 = f6_arg1.errorString
	end
	f6_local0( f6_local1 )
	f6_local0 = {
		popup_title = Engine[0xED84C33EC5F01EA]( 0xD09E09A43DE9B80 ),
		message_text = f6_arg1.errorString,
		controllerIndex = f6_arg1.controllerIndex or 0
	}
	if CONDITIONS.MobileIsBootPresentationEnabled() and Dvar[0x9E5BE3B4BBA4E0E]( 0xE8A6179AA3EFA7F ) then
		Web[0xE98F74F6BE5B05E]( "", f6_local0.message_text, f6_local0.popup_title, "" )
	end
	local f6_local2 = nil
	if CONDITIONS.IsCortezSubExe() then
		f6_local0.no_text = Engine[0xED84C33EC5F01EA]( 0x591BF0CC8C6FD71 )
		f6_local0.no_action = function ( f9_arg0, f9_arg1 )
			PLAY_MENU.ForcePlayerBackToCODHQExecutableOffline( f9_arg1.controller )
		end
		
		f6_local0.yes_text = Engine[0xED84C33EC5F01EA]( 0x3956F54E845F7DE )
		if CONDITIONS.IsPC() then
			f6_local0.cancel_text = Engine[0xED84C33EC5F01EA]( 0x4E76830223A336F )
			f6_local0.cancel_action = function ( f8_arg0, f8_arg1 )
				Engine[0xDEE6107B26F8BB6]()
			end
			
			f6_local2 = MenuBuilder.BuildRegisteredType( "generic_yesnocancel_popup", f6_local0 )
		else
			f6_local2 = MenuBuilder.BuildRegisteredType( "generic_yesno_popup", f6_local0 )
		end
	else
		if CONDITIONS.IsPC() then
			f6_local0.button_text = Engine[0xED84C33EC5F01EA]( 0x4E76830223A336F )
			f6_local0.confirmation_action = function ( f7_arg0, f7_arg1 )
				Engine[0xDEE6107B26F8BB6]()
			end
			
		end
		f6_local2 = MenuBuilder.BuildRegisteredType( "generic_confirmation_popup", f6_local0 )
	end
	f6_local2.id = "popup_getting_data_error"
	return f6_local2
end

function PopupGettingDataCancelled( f5_arg0, f5_arg1 )
	local f5_local0 = {
		popup_title = Engine[0xED84C33EC5F01EA]( 0x1CCA5C59ECE1EA6 ),
		message_text = Engine[0xED84C33EC5F01EA]( 0x2EEFB111F5CE9F6 ),
		label = Engine[0xED84C33EC5F01EA]( 0x5C33DA8F6CE65B0 ),
		controllerIndex = f5_arg1.controllerIndex or 0
	}
	if CONDITIONS.MobileIsBootPresentationEnabled() and Dvar[0x9E5BE3B4BBA4E0E]( 0xE8A6179AA3EFA7F ) then
		Web[0xE98F74F6BE5B05E]( "", f5_local0.message_text, f5_local0.popup_title, "" )
	end
	local f5_local1 = MenuBuilder.BuildRegisteredType( "generic_confirmation_popup", f5_local0 )
	f5_local1.id = "popup_getting_data_cancelled"
	return f5_local1
end

MenuBuilder.registerType( "popup_getting_data", PopupGettingData )
MenuBuilder.registerType( "popup_getting_data_error", PopupGettingDataError )
MenuBuilder.registerType( "popup_getting_data_cancelled", PopupGettingDataCancelled )
LUI.Fence.Register( "onlineData", FenceOnlineData )
FenceMainOnlineData = LUI.Class( FenceOnlineData )
FenceMainOnlineData.init = function ( f4_arg0 )
	FenceMainOnlineData.super.init( f4_arg0, FenceOnlineData.GAMEMODE_TYPE.none )
end

LUI.Fence.Register( "mainOnlineData", FenceMainOnlineData )
FenceSPOnlineData = LUI.Class( FenceOnlineData )
FenceSPOnlineData.init = function ( f3_arg0 )
	FenceSPOnlineData.super.init( f3_arg0, FenceOnlineData.GAMEMODE_TYPE.sp )
end

LUI.Fence.Register( "spOnlineData", FenceSPOnlineData )
FenceMPOnlineData = LUI.Class( FenceOnlineData )
FenceMPOnlineData.init = function ( f2_arg0 )
	FenceMPOnlineData.super.init( f2_arg0, FenceOnlineData.GAMEMODE_TYPE.mp )
end

LUI.Fence.Register( "mpOnlineData", FenceMPOnlineData )
FenceCPOnlineData = LUI.Class( FenceOnlineData )
FenceCPOnlineData.init = function ( f1_arg0 )
	FenceCPOnlineData.super.init( f1_arg0, FenceOnlineData.GAMEMODE_TYPE.cp )
end

LUI.Fence.Register( "cpOnlineData", FenceCPOnlineData )
LockTable( _M )
