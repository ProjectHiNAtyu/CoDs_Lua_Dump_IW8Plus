-- Generated by CoDLuaDecompiler
-- Version: 2.4.2
-- Date: 27-09-2025 22:41
module( ..., package.seeall )
FenceSignIn = LUI.Class( LUI.Fence )
FenceSignIn.ACCOUNT_PICKER_STATE = {
	picking = 2,
	inactive = 1
}
FenceSignIn.BattleNetSignInState = {
	signedIn = 2,
	error = 3,
	idle = 0,
	signingIn = 1
}
FenceSignIn.init = function ( f17_arg0 )
	LUI.Fence.init( f17_arg0 )
	f17_arg0._force2FABlock = false
	f17_arg0._perController = {}
	f17_arg0._show2FAWarning = true
	for f17_local0 = 0, Engine.DCJGJDDEHE() - 1, 1 do
		f17_arg0._perController[f17_local0] = {
			accountPickerState = FenceSignIn.ACCOUNT_PICKER_STATE.inactive
		}
	end
end

FenceSignIn.Start = function ( f16_arg0 )
	DebugPrint( "FenceSignIn.Start" )
end

FenceSignIn.Stop = function ( f15_arg0 )
	DebugPrint( "FenceSignIn.Stop" )
end

FenceSignIn.PostFail = function ( f14_arg0 )
	if f14_arg0._state == LUI.Fence.STATE.fail then
		if f14_arg0._force2FABlock then
			LUI.FlowManager.RequestPopupMenu( nil, "popup_force_2fa_block", false, nil, false, {}, nil, false, true )
		elseif Fences.BDEBEIHECI() then
			LUI.FlowManager.RequestPopupMenu( nil, "popup_signin_error", false, nil, false, {}, nil, false, true )
		end
	end
end

function PopupSignInQueue( f12_arg0, f12_arg1 )
	assert( f12_arg1 )
	local f12_local0 = {
		message = Engine.CBBHFCGDIC( "LUA_MENU_MP/SERVER_QUEUE" ),
		description = Engine.CBBHFCGDIC( "PLATFORM/BNET_SERVER_QUEUE_MSG" )
	}
	local f12_local1 = {}
	local f12_local2 = Engine.CBBHFCGDIC
	local f12_local3
	if Engine.CGABICJHAI() then
		f12_local3 = "LUA_MENU/QUIT_DESKTOP"
	else
		f12_local3 = "MENU/EXIT"
	end
	f12_local1.label = f12_local2( f12_local3 )
	f12_local1.alignment = LUI.Alignment.Center
	f12_local1.action = function ()
		if Engine.CGABICJHAI() then
			Engine.DJEDDFJEIG()
		else
			LUI.FlowManager.RequestLeaveMenu()
		end
	end
	
	f12_local0.buttons = f12_local1
	f12_local1 = f12_arg1.controllerIndex
	if not f12_local1 then
		f12_local1 = Engine.IJEBHJIJF()
	end
	f12_local0.controllerIndex = f12_local1
	f12_local1 = MenuBuilder.BuildRegisteredType( "FenceSigninQueueDialogPopup", f12_local0 )
	f12_local1.id = "popup_signin_queue"
	return f12_local1
end

FenceSignIn.OpenSignInQueuedPopup = function ( f10_arg0 )
	local f10_local0 = f10_arg0
	LUI.FlowManager.RequestPopupMenu( nil, "popup_signin_queue", false, nil, false, {
		onCancel = function ( f11_arg0, f11_arg1 )
			f10_arg0._perController[f11_arg1].isCancelling = true
		end
	}, nil, true, true )
	f10_arg0._openedWaitPopup = "popup_signin_queue"
end

FenceSignIn.UpdateState = function ( f8_arg0 )
	assert( f8_arg0._state ~= LUI.Fence.STATE.fail )
	f8_arg0._state = LUI.Fence.STATE.pass
	if Engine.EAAHJIGHHI() then
		f8_arg0._state = LUI.Fence.STATE.pass
	end
	if Engine.DBFCJBDJEC() then
		local f8_local0 = 0
		if not Engine.CDCCDDJAJJ( f8_local0 ) then
			local f8_local1 = Engine.BIBHHEJBIB()
			local f8_local2 = function ( f9_arg0 )
				if f8_arg0._openedWaitPopup ~= nil and f8_arg0._openedWaitPopup ~= f9_arg0 then
					LUI.FlowManager.RequestLeaveMenuByName( f8_arg0._openedWaitPopup, true )
					f8_arg0._openedWaitPopup = nil
					return true
				elseif f8_arg0._openedWaitPopup == nil then
					return true
				else
					return false
				end
			end
			
			if f8_local1 then
				if f8_local2( "popup_signin_queue" ) then
					f8_arg0:OpenSignInQueuedPopup()
				end
			elseif f8_arg0._openedWaitPopup then
				LUI.FlowManager.RequestLeaveMenuByName( f8_arg0._openedWaitPopup, true )
				f8_arg0._openedWaitPopup = nil
			end
			local f8_local3 = Engine.BDJHIJJHGG( f8_local0 )
			if f8_local3 == FenceSignIn.BattleNetSignInState.error then
				f8_arg0._state = LUI.Fence.STATE.fail
			elseif f8_local3 ~= FenceSignIn.BattleNetSignInState.signedIn then
				f8_arg0._state = LUI.Fence.STATE.block
			end
		elseif Engine.CGABICJHAI() and Dvar.IBEGCHEFE( "OMTMMOTQOO" ) and OnlineABTesting.DEFDBJBAJ( f8_local0 ) and TwoFactorAuth.DGEDAGGDJC( f8_local0 ) and not Engine.CFHBIHABCB( f8_local0 ) and f8_arg0._show2FAWarning and (TwoFactorAuth.CGFIJBGHEB() or Dvar.CFHDGABACF( "LMTKLKNROQ" ) == 0) then
			local f8_local1 = TwoFactorAuth.DGGBCHIBEF()
			if f8_local1 < 0 or Dvar.CFHDGABACF( "LMTKLKNROQ" ) == 0 then
				Engine.CEJJDJJHIJ( f8_local0, "dlog_event_2fa_disabled_block_popup", {} )
				Dvar.DFIJDJFIFD( "LMLQLMQOSR", 0 )
				f8_arg0._state = LUI.Fence.STATE.fail
				f8_arg0._force2FABlock = true
			else
				f8_arg0._show2FAWarning = false
				Engine.CEJJDJJHIJ( f8_local0, "dlog_event_2fa_warning_popup", {
					logins_remaining = f8_local1
				} )
				if Engine.BECCFCBIAA( "hasEverSeen_CODAccountOTP", f8_local0 ) == 1 then
					LUI.FlowManager.RequestPopupMenu( nil, "CODAccountAuthenticationAdv", true, f8_local0, false, {
						tfa_warning = true,
						state = f8_arg0,
						logins_remaining = f8_local1
					}, nil, true, true )
				end
			end
		end
		return 
	elseif Engine.JIFHCDAFB() then
		f8_arg0._state = LUI.Fence.STATE.block
		return 
	end
	for f8_local4 = 0, Engine.DCJGJDDEHE() - 1, 1 do
		if Engine.BBHAECABBD( f8_local4 ) and not Engine.CDCCDDJAJJ( f8_local4 ) then
			local f8_local5 = assert
			local f8_local6 = Engine.BAHIIBFDDG()
			if not f8_local6 then
				f8_local6 = Engine.BEFACAIFDD()
			end
			f8_local5( f8_local6 )
			if f8_arg0._perController[f8_local4].accountPickerState == FenceSignIn.ACCOUNT_PICKER_STATE.inactive then
				f8_arg0._state = LUI.Fence.STATE.block
				f8_arg0._perController[f8_local4].accountPickerState = FenceSignIn.ACCOUNT_PICKER_STATE.picking
				Engine.BGEFGFACEH( f8_local4, false )
				return 
			end
		end
	end
	local f8_local4 = 0
	local f8_local1 = 0
	for f8_local2 = 0, Engine.DCJGJDDEHE() - 1, 1 do
		if Engine.BBHAECABBD( f8_local2 ) and Engine.CDCCDDJAJJ( f8_local2 ) then
			f8_local4 = f8_local4 + 1
			if not Engine.DBAEJAHFGJ( f8_local2 ) then
				f8_local1 = f8_local1 + 1
			end
		end
	end
	local f8_local2 = false
	if Dvar.IBEGCHEFE( "LPSPMQSNPQ" ) and Engine.CIEGIACHAE() and 0 < f8_local4 then
		f8_local2 = true
	end
	if 0 < f8_local4 and 0 < f8_local1 then
		f8_local2 = true
	end
	if f8_local2 then
		for f8_local3 = 0, Engine.DCJGJDDEHE() - 1, 1 do
			if Engine.BBHAECABBD( f8_local3 ) and not Engine.CDCCDDJAJJ( f8_local3 ) then
				Engine.CIHFHAIIHC( f8_local3 )
				f8_arg0._perController[f8_local3].accountPickerState = FenceSignIn.ACCOUNT_PICKER_STATE.inactive
			end
		end
	else
		f8_arg0._state = LUI.Fence.STATE.fail
	end
end

function PopupSignInError( f4_arg0, f4_arg1 )
	local f4_local0 = "LUA_MENU/PROFILE_NOT_SIGNED_IN"
	if Engine.CIEGIACHAE() then
		f4_local0 = "PLATFORM/NOT_SIGNED_IN"
	end
	if Engine.EAAHGICFBD() then
		f4_local0 = "XBOXLIVE/MUSTLOGIN"
	end
	local f4_local1 = {
		controllerIndex = f4_arg1.controllerIndex,
		title = Engine.CBBHFCGDIC( "MENU/SIGN_IN" ),
		message = Engine.CBBHFCGDIC( f4_local0 ),
		buttons = {
			{
				label = Engine.CBBHFCGDIC( "MENU/OK" )
			}
		}
	}
	if Engine.DBFCJBDJEC() then
		f4_local1.message = Engine.DJHABIGCGE()
		f4_local1.buttons[1].label = Engine.CBBHFCGDIC( "LUA_MENU/QUIT_DESKTOP" )
		f4_local1.buttons[1].action = function ()
			Engine.DJEDDFJEIG()
		end
		
		if Engine.EDFJDAHID() then
			table.insert( f4_local1.buttons, 1, {
				label = Engine.CBBHFCGDIC( "PLATFORM/GO_TO_BLIZZARD_ACCOUNT_SETTINGS" ),
				action = function ()
					Engine.BHECIAHGC( f4_arg0.controllerIndex, 0, "https://account.blizzard.com/details#phone-number" )
				end
			} )
		end
		if Engine.DBDHEJCHCI() then
			Lobby.ForceEndPlayerLFPSession( {
				resetAllData = false,
				eventName = Lobby.LFPEvents.DISCONNECT
			} )
			f4_local1.title = Engine.CBBHFCGDIC( "EXE/SERVER_DISCONNECTED" )
		end
	end
	local f4_local2 = MenuBuilder.BuildRegisteredType( "GenericImagePopup", f4_local1 )
	f4_local2.id = "popup_signin_error"
	f4_local2:registerEventHandler( "not_below_blocking_fence", function ( element, event )
		if Engine.BAHIIBFDDG() then
			Engine.CEEHHDEHJB( "Sign in fence failed" )
			Dvar.DHEGHJJJHI( "splitscreen", false )
		end
	end )
	return f4_local2
end

function PopupForce2FABlock( f1_arg0, f1_arg1 )
	assert( f1_arg1 )
	local f1_local0 = {
		message = Engine.CBBHFCGDIC( "CODACCOUNT/TFA_BLOCK_MESSAGE" ),
		title = Engine.CBBHFCGDIC( "CODACCOUNT/LOGIN_ERROR_TITLE" ),
		buttons = {
			{
				label = Engine.CBBHFCGDIC( "MENU/OK" )
			},
			{
				label = Engine.CBBHFCGDIC( "MENU/OK" )
			}
		},
		controllerIndex = f1_arg1.controllerIndex,
		imageOverride = "logo_wz_shadow"
	}
	f1_local0.buttons[1].label = Engine.CBBHFCGDIC( "CODACCOUNT/TFA_BTN_ENROLL" )
	f1_local0.buttons[1].action = function ()
		Engine.BHECIAHGC( f1_arg0.controllerIndex, WebBrowserType.FULLSCREEN, CODACCOUNT.AccountSettingsURL )
		Engine.DJEDDFJEIG()
	end
	
	f1_local0.buttons[2].label = Engine.CBBHFCGDIC( "LUA_MENU/QUIT_DESKTOP" )
	f1_local0.buttons[2].action = function ()
		Engine.DJEDDFJEIG()
	end
	
	local f1_local1 = MenuBuilder.BuildRegisteredType( "GenericImagePopup", f1_local0 )
	f1_local1.id = "popup_force_2fa_block"
	return f1_local1
end

MenuBuilder.registerType( "popup_signin_queue", PopupSignInQueue )
MenuBuilder.registerType( "popup_signin_error", PopupSignInError )
MenuBuilder.registerType( "popup_force_2fa_block", PopupForce2FABlock )
LUI.Fence.Register( "signIn", FenceSignIn )
LockTable( _M )
