-- Generated by CoDLuaDecompiler
-- Version: 2.4.2
-- Date: 30-11-2025 17:02
module( ..., package.seeall )
local f0_local0 = function ( f18_arg0, f18_arg1, f18_arg2, f18_arg3 )
	local f18_local0 = LUI.DeepCopy( f18_arg0._weaponTable )
	if f18_arg2 then
		f18_local0.attachments[f18_arg2].ref = ATTACHMENT.none
		f18_local0.attachments[f18_arg2].variantID = ATTACHMENT.baseVariant
	end
	if not f18_arg1 then
		f18_arg1 = #f18_local0.attachments + 1
	end
	if f18_arg3 then
		f18_local0.attachments[f18_arg1] = f18_local0.attachments[f18_arg1] or {}
		f18_local0.attachments[f18_arg1].ref = f18_arg0._attachRef
		f18_local0.attachments[f18_arg1].variantID = f18_arg3
	end
	return f18_local0
end

local f0_local1 = function ( f17_arg0, f17_arg1, f17_arg2, f17_arg3 )
	if not Engine[0x12586A3F4FB490E]() or not f17_arg0._weaponModel then
		return 
	else
		WEAPON.LoadAndSetModel( f17_arg1, f17_arg0._weaponModel, f17_arg0._currentTable, {
			forceOffsetsAndRotations = true
		} )
	end
end

local f0_local2 = function ( f16_arg0, f16_arg1, f16_arg2, f16_arg3 )
	local f16_local0 = Reticle[0x15C60EB1A12545F]( f16_arg1, WEAPON.GetWeaponModelName( f16_arg2.weapon, f16_arg2, {
		includeAttachments = true
	} ), false )
	if not String.IsNilOrEmpty( f16_local0 ) and f16_arg3.menuName == "AttachmentAppearanceSelect" and f16_arg0._category == ATTACHMENT.opticCategory and f16_arg0.ReticlePreview then
		ACTIONS.AnimateSequence( f16_arg0, "ShowReticle" )
		f16_arg0.ReticlePreview:SetPreviewImage( f16_local0 )
	else
		ACTIONS.AnimateSequence( f16_arg0, "HideReticle" )
	end
end

local f0_local3 = function ( f14_arg0, f14_arg1, f14_arg2 )
	return function ()
		FrontEndScene.SetExclusiveWeaponModels( {
			FrontEndScene.ClientWeapons.Preview
		} )
		f14_arg0._weaponModel = WEAPON.GetWeaponModel( f14_arg0, FrontEndScene.ClientWeapons.Preview, WEAPON.OffsetFiles.AttachmentData )
		f14_arg0:addElement( f14_arg0._weaponModel )
		f14_arg0( f14_arg0, f14_arg0, f14_arg0, f14_arg0._currentVariantID )
	end
	
end

local f0_local4 = function ( f5_arg0, f5_arg1, f5_arg2 )
	if Engine[0x2DA54CF5D6B7F02]() then
		if not f5_arg2.weaponSlot then
			f5_arg2.weaponSlot = 0
		end
		if not f5_arg2.loadoutIndex then
			f5_arg2.loadoutIndex = 0
		end
		if not f5_arg2.variantData then
			f5_arg2.variantData = {}
		end
		if not f5_arg2.attachmentRef then
			f5_arg2.attachmentRef = "acog"
		end
	end
	if f5_arg0.ItemDetails then
		f5_arg0.ItemDetails:SetupForAttachmentSkins()
		f5_arg0.EnlargeKBMPrompt:SetupPrompt( {
			text = 0xA4E4A8C660FD253,
			buttonPrompt = ButtonMap.button_right_trigger,
			action = function ( f13_arg0, f13_arg1 )
				if f5_arg0.ItemDetails and f5_arg0.ItemDetails.BlueprintBinkPreview:IsVisible() and f5_arg0.ItemDetails._binkToPreview then
					STORE.Popups.OpenBinkPreviewPopup( f5_arg0.ItemDetails, f13_arg1.controller, f5_arg0.ItemDetails._binkToPreview )
				end
			end
		} )
	else
		f5_arg0.EnlargeKBMPrompt:SetVisible( false )
	end
	if 1 < #f5_arg2.variantData then
		table.sort( f5_arg2.variantData, function ( f12_arg0, f12_arg1 )
			if not f12_arg0 then
				return false
			elseif not f12_arg1 then
				return true
			else
				return f12_arg0.variantID < f12_arg1.variantID
			end
		end )
	end
	local f5_local0 = LOADOUT.GetFrontendLoadoutWithShowcase( f5_arg1, f5_arg2.loadoutIndex, f5_arg2.forShowcase )
	f5_arg0._weaponPlayerData = f5_local0.weaponSetups[f5_arg2.weaponSlot]
	f5_arg0._weaponTable = WEAPON.GenerateWeaponTable( f5_arg0._weaponPlayerData )
	f5_arg0._controllerIndex = f5_arg1
	if f5_arg0.DetailedEquippedSlots then
		f5_arg0.DetailedEquippedSlots:Setup( f5_arg0._weaponTable, f5_arg2.category )
		local f5_local1 = 0
		for f5_local5, f5_local6 in ddlpairs( f5_arg0._weaponPlayerData.attachmentSetup ) do
			if ATTACHMENT.GetRefFromSetup( f5_local6 ) ~= ATTACHMENT.none then
				f5_local1 = f5_local1 + 1
			end
		end
		f5_arg0.DetailedEquippedSlots.EquippedText:setText( Engine[0xED84C33EC5F01EA]( 0x1E1C8D199A4092D, f5_local1, WEAPON.maxAttachmentsPerWeapon ) )
	end
	f5_arg0._attachRef = f5_arg2.attachmentRef
	local f5_local1 = f5_arg2.attachmentRef
	f5_arg0.MenuTitle:SetTitle( Engine[0xED84C33EC5F01EA]( 0x1580DB40A0528B1 ) )
	local f5_local2, f5_local3 = nil
	if f5_arg2.attachSlot then
		f5_local2 = f5_arg0._weaponPlayerData.attachmentSetup[f5_arg2.attachSlot - 1].variantID:get()
		f5_local3 = ATTACHMENT.GetRefFromSetup( f5_arg0._weaponPlayerData.attachmentSetup[f5_arg2.attachSlot - 1] )
	end
	f5_arg0._equippedAttach = f5_local3
	f5_arg0._attachmentData = f5_arg2.attachmentData
	f5_arg0._category = f5_arg2.category
	local f5_local4 = f5_local3 == f5_arg0._attachRef
	local f5_local5 = 0
	if f5_arg0.AttachmentAppearanceDetails and f5_local2 and f5_local4 then
		for f5_local15, f5_local16 in ipairs( f5_arg2.variantData ) do
			if f5_local2 == f5_local16.variantID then
				f5_local5 = f5_local15
				local f5_local9 = ATTACHMENT.GetName( f5_local1, f5_arg0._weaponTable.weapon )
				local f5_local10 = f5_arg0.AttachmentAppearanceDetails
				local f5_local11 = f5_local10
				f5_local10 = f5_local10.Setup
				local f5_local12 = f5_local16
				local f5_local13 = f5_arg0._weaponTable
				local f5_local14
				if f5_local4 then
					f5_local14 = f5_local4
				else
					f5_local14 = f5_local2
				end
				f5_local10( f5_local11, f5_local12, f5_local13, f5_local14, f5_arg2.blockedCategorySlot, f5_local9 )
			end
		end
	end
	f5_arg0.Attachments:SetNumChildren( 0 )
	f5_arg0.Attachments:SetRefreshChild( function ( f11_arg0, f11_arg1, f11_arg2 )
		local f11_local0 = f5_arg0.variantData[f5_arg0.Attachments:GetContentIndex( f11_arg1, f11_arg2 ) + 1]
		local f11_local1
		if f5_arg0 == f11_local0.variantID then
			f11_local1 = f5_arg0
		else
			f11_local1 = false
		end
		f11_arg0:Setup( f11_local0, f11_local1, f5_arg0._weaponPlayerData.weapon:get() )
		f11_arg0:SetDisabled( not PROGRESSION.IsUnlockedWithID( f5_arg0, ATTACHMENT.GetLootIDForVariant( f5_arg0._weaponTable.weapon, f11_local0.ref, f11_local0.variantID ) ) )
	end )
	f5_arg0.Attachments:SetNumChildren( #f5_arg2.variantData )
	f5_arg0.Attachments:SetDefaultFocus( f5_arg0.Attachments:GetPositionForIndex( f5_local5, {
		relativePosition = false
	} ) )
	f5_arg0.Attachments:RefreshContent()
	for f5_local6 = 1, #f5_arg2.variantData, 1 do
		FrontEndScene.RequestWeaponViewModels( {
			WEAPON.GetWeaponModelName( f5_arg0._weaponTable.weapon, f0_local0( f5_arg0, f5_arg2.attachSlot, f5_arg2.blockedCategorySlot, f5_arg2.variantData[f5_local6].variantID ), {
				includeCamos = true,
				includeAttachments = true,
				includeStickers = true,
				controllerIndex = f5_arg1
			} )
		}, f5_arg1 )
	end
	local f5_local6 = ATTACHMENT.GetName( f5_local1, f5_arg0._weaponTable.weapon )
	f5_arg0:registerEventHandler( "update_showcase", function ( element, event )
		if element.AttachmentAppearanceDetails then
			element.AttachmentAppearanceDetails:Setup( event.variantData, element._weaponTable, f5_arg0 and f5_arg0, f5_arg0.blockedCategorySlot, f5_arg0 )
		elseif element.ItemDetails then
			local f10_local0 = 0x23ABF974ED0021F
			if event.variantData.variantID ~= ATTACHMENT.baseVariant then
				f10_local0 = event.variantData.name
			end
			local f10_local1 = ATTACHMENT.GetLootIDForVariant( element._weaponTable.weapon, event.variantData.ref, event.variantData.variantID )
			local f10_local2 = {
				name = f10_local0,
				localizedDesc = f5_arg0,
				weaponTable = element._weaponTable,
				tacticalBuildData = event.tacticalBuildData,
				variantData = event.variantData,
				lootID = f10_local1,
				attachmentRef = ATTACHMENT.GetRefByID( f10_local1 ),
				isUnlocked = PROGRESSION.IsUnlockedWithID( f5_arg0, f10_local1 )
			}
			if not String.IsNilOrEmpty( event.variantData.desc ) then
				f10_local2.localizedDesc = f10_local2.localizedDesc .. "\n" .. Engine[0xED84C33EC5F01EA]( event.variantData.desc )
			end
			element.ItemDetails:UpdateDetails( f10_local2 )
		end
		element._currentVariantID = event.variantData.variantID
		local f10_local0 = LUI.FlowManager.GetScopedData( LOADOUT.GetGunsmithTabsMenuRef() )
		element._currentTable = ATTACHMENT.GetTableWithAttachmentEquipped( f5_arg0, element._weaponTable, element._equippedAttach, element._attachRef, element._category, element._currentVariantID, f5_arg0.attachSlot, element._attachmentData, f10_local0.attachmentData[GL_HACK.GetWeaponMPRef( element._weaponTable.weapon )].attachments )
		f5_arg0( element, f5_arg0, element._attachRef, event.variantData.variantID )
		f5_arg0( element, f5_arg0, element._currentTable, f5_arg0 )
		if CONDITIONS.InFrontend() and (element._category == ATTACHMENT.perkCategory or element._category == ATTACHMENT.boltCategory) then
			GUNSMITH.UpdateAmmoModel( element, f5_arg0 )
		end
	end )
	f5_arg0:registerEventHandler( "try_equip_attachment", function ( element, event )
		GUNSMITH.TryEquipAttachment( element, event, f5_arg0.attachSlot )
	end )
	f5_arg0:registerEventHandler( "equip_attachment", function ( element, event )
		GUNSMITH.EquipAttachmentEventHandler( element, event, {
			isInAttachmentSelect = false,
			parentMenu = element,
			attachSlot = f5_arg0.attachSlot
		} )
	end )
	if Engine[0x12586A3F4FB490E]() then
		MenuUtils.SetupSceneChangeCallback( f5_arg0, f0_local0( f5_arg0, f5_arg1 ) )
		f5_arg0._currentTable = f0_local0( f5_arg0, f5_arg2.attachSlot )
		if CONDITIONS.IsWeaponPreviewEnabled() and not CONDITIONS.IsMobileOrMobileSim() then
			f5_arg0.HelperBar.ButtonHelperText:PushButtonPrompt( {
				side = "left",
				priority = 10,
				button_ref = "button_r3",
				helper_text = Engine[0xED84C33EC5F01EA]( 0xCBEAF62674E5E75 ),
				helper_definition = Engine[0xED84C33EC5F01EA]( 0xF2D581450245105 )
			} )
			f5_arg0:AddGamepadEventCallback( "button_right_stick", function ( f7_arg0, f7_arg1 )
				f5_arg0.weaponTable = f7_arg0._currentTable
				LUI.FlowManager.RequestAddMenu( "WeaponPreview", true, f7_arg1.controller or f5_arg0, false, f5_arg0, true )
			end )
		end
	end
	f5_arg0:addEventHandler( "menu_create", function ( f6_arg0, f6_arg1 )
		f6_arg0.Attachments:processEvent( {
			name = "gain_focus",
			controller = f6_arg1.controller
		} )
	end )
end

local f0_local5 = function ( f4_arg0, f4_arg1, f4_arg2 )
	f4_arg0.PostLoadShared = f0_local0
end

function AttachmentAppearanceSelectBase( f1_arg0, f1_arg1 )
	local f1_local0 = ACTIONS
	local f1_local1 = LUI
	local f1_local2 = f1_local1.UIMenu.new()
	f1_local2.id = "AttachmentAppearanceSelectBase"
	local f1_local3
	if f1_arg1 then
		f1_local3 = f1_arg1
	else
		f1_local3 = f1_arg1.controllerIndex
	end
	f1_local3 = f1_local1.ValidateControllerIndex( f1_local2, f1_local3 )
	local f1_local4 = f1_local2
	f1_local2.addButtonHelperFunction = function ( f3_arg0, f3_arg1 )
		f3_arg0:AddButtonHelperText( {
			side = "left",
			button_ref = "button_primary",
			priority = 2,
			helper_text = Engine[0xED84C33EC5F01EA]( 0x1A9362F611D2930 )
		} )
	end
	
	f1_local2:addEventHandler( 0xC462F90231FE727, f1_local2[0x32E3061DF227E68] )
	f1_local2:AddGamepadEventCallback( 0x691AB96D9875434, function ( f2_arg0, f2_arg1 )
		local f2_local0 = f2_arg1.controller or f1_arg0
		if not CONDITIONS.IsMobileOrMobileSim() then
			f1_arg0:LeaveMenu()
		end
	end )
	f0_local0( f1_local2, f1_local3, f1_arg1 )
	return f1_local2
end

MenuBuilder.registerType( 0x79DB4EB00095D4F, AttachmentAppearanceSelectBase )
LockTable( _M )
